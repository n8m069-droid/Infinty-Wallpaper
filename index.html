<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Gallery Clock Â· Chromatic Cosmos</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:ital,wght@0,300;0,400;0,700;1,300&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Share+Tech+Mono&family=Cinzel:wght@400;700&family=Righteous&family=Caveat:wght@400;700&family=Josefin+Sans:wght@100;300;400&family=Cormorant+Garamond:ital,wght@0,300;0,600;1,300&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
html,body{width:100%;height:100%;overflow:hidden;background:#000}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYER STACK (z-index map)
   0  â†’ skyCanvas (circadian sky)
   1  â†’ bg  (photo base)
   2  â†’ inkCanvas (ink bloom)
   3  â†’ ambientCanvas (particles + ripples)
   4  â†’ moodTint / overlay
   5  â†’ spectrumCanvas (FFT halo, behind clock)
   6  â†’ ui / colorBar
   7  â†’ clockWrap
   8  â†’ poetryDisplay
   9  â†’ wbPill / soundBtn
   10 â†’ wbPanel
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

/* â”€â”€ CIRCADIAN SKY â”€â”€ */
#skyCanvas{position:fixed;inset:0;z-index:0;pointer-events:none}

/* â”€â”€ WALLPAPER (parallax-shifted via transform) â”€â”€ */
#bg{position:fixed;inset:-4%;width:108%;height:108%;background-size:cover;background-position:center;z-index:1;will-change:transform;transition:transform .08s linear}

/* â”€â”€ INK BLOOM â”€â”€ */
#inkCanvas{position:fixed;inset:0;z-index:2;pointer-events:none}

/* â”€â”€ PARTICLES + RIPPLES â”€â”€ */
#ambientCanvas{position:fixed;inset:0;z-index:3;pointer-events:none}

/* â”€â”€ MOOD TINT â”€â”€ */
#moodTint{position:fixed;inset:0;z-index:4;pointer-events:none;transition:background 2.5s ease}

/* â”€â”€ BREATHING VIGNETTE â”€â”€ */
.overlay{position:fixed;inset:0;z-index:4;pointer-events:none;
  background:linear-gradient(160deg,rgba(0,0,0,.3) 0%,rgba(0,0,0,0) 38%,rgba(0,0,0,0) 58%,rgba(0,0,0,.72) 100%);
  --bd:12s;animation:breathe var(--bd) ease-in-out infinite}
@keyframes breathe{0%,100%{opacity:1}50%{opacity:.52}}

/* â”€â”€ SPECTRUM CANVAS (FFT halo â€” sits behind clockWrap) â”€â”€ */
#spectrumCanvas{position:fixed;inset:0;z-index:5;pointer-events:none}

/* â”€â”€ COLOR DNA BAR â”€â”€ */
#colorBar{position:fixed;bottom:0;left:0;right:0;z-index:6;display:flex;align-items:flex-end;height:12px;pointer-events:none}
.cb-seg{flex:1;min-width:1px;transition:height .7s ease,background .7s ease;transform-origin:bottom}

/* â”€â”€ LOAD BAR â”€â”€ */
#loadBar{position:fixed;top:0;left:0;height:3px;width:0;z-index:100;transition:width .4s,opacity .4s,background 1.2s}

/* â”€â”€ UI LAYER â”€â”€ */
.ui{position:fixed;inset:0;z-index:6;display:flex;flex-direction:column;justify-content:space-between;padding:clamp(16px,3vw,48px);pointer-events:none}
.top{display:flex;align-items:flex-start;justify-content:space-between}
.brand{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:clamp(11px,1.2vw,16px);letter-spacing:.4em;text-transform:uppercase;color:rgba(255,255,255,.5);text-shadow:0 1px 8px rgba(0,0,0,.5)}
.img-count{font-family:'Share Tech Mono',monospace;font-size:clamp(11px,1vw,14px);color:rgba(255,255,255,.35);letter-spacing:.15em}

/* â”€â”€ CLOCK WRAP â”€â”€ */
#clockWrap{position:absolute;z-index:7;pointer-events:none;transition:opacity .5s}
#clockWrap.hidden{opacity:0}

/* â”€â”€ BOTTOM BAR â”€â”€ */
.bottom{display:flex;align-items:flex-end;justify-content:space-between;gap:16px}
.photo-info{max-width:60%}
.photo-author{font-family:'DM Sans',sans-serif;font-weight:300;font-size:clamp(10px,1.1vw,14px);color:rgba(255,255,255,.45);letter-spacing:.12em;text-transform:uppercase;margin-bottom:4px;text-shadow:0 1px 6px rgba(0,0,0,.6)}
.photo-id{font-family:'Share Tech Mono',monospace;font-size:clamp(9px,.9vw,12px);color:rgba(255,255,255,.25)}

/* â”€â”€ EMOTIONAL RADAR â”€â”€ */
#emotionRadar{margin-top:8px;opacity:0;transition:opacity 1.2s ease}
#emotionRadar.visible{opacity:1}
#emotionRadar canvas{display:block}

/* â”€â”€ AI POETRY DISPLAY â”€â”€ */
#poetryDisplay{
  position:fixed;left:50%;bottom:clamp(65px,10vw,110px);
  transform:translateX(-50%);z-index:8;
  text-align:center;pointer-events:none;
  max-width:min(580px,80vw);
  opacity:0;transition:opacity 1.6s ease;
}
#poetryDisplay.visible{opacity:1}
.poetry-line{
  font-family:'Cormorant Garamond',serif;font-style:italic;font-weight:300;
  font-size:clamp(13px,1.6vw,20px);line-height:1.55;
  color:rgba(255,255,255,.72);
  text-shadow:0 2px 20px rgba(0,0,0,.8),0 0 60px rgba(255,255,255,.08);
  letter-spacing:.03em;display:block;
}
.poetry-line:nth-child(2){color:rgba(255,255,255,.5);font-size:clamp(11px,1.3vw,17px)}

/* â”€â”€ NEXT BUTTON â”€â”€ */
#nextBtn{pointer-events:all;display:flex;align-items:center;gap:12px;background:rgba(255,255,255,.12);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.2);color:#fff;cursor:pointer;padding:clamp(10px,1.5vw,16px) clamp(16px,2.5vw,32px);font-family:'Josefin Sans',sans-serif;font-weight:300;font-size:clamp(11px,1.2vw,15px);letter-spacing:.25em;text-transform:uppercase;outline:none;border-radius:2px;transition:background .25s,border-color .25s,transform .1s;flex-shrink:0}
#nextBtn:hover{background:rgba(255,255,255,.22);border-color:rgba(255,255,255,.4)}
#nextBtn:active{transform:scale(.97)}
#nextBtn svg{width:clamp(14px,1.5vw,20px);height:clamp(14px,1.5vw,20px);stroke:rgba(255,255,255,.8);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;transition:transform .3s}
#nextBtn:hover svg{transform:translateX(4px)}

/* â”€â”€ HUD PILL â”€â”€ */
#wbPill{position:fixed;top:clamp(16px,2.5vw,36px);left:50%;transform:translateX(-50%);z-index:9;pointer-events:all;cursor:pointer;display:flex;align-items:center;gap:8px;background:rgba(0,0,0,.45);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,.14);border-radius:100px;padding:7px 16px 7px 12px;transition:background .3s,transform .2s;white-space:nowrap;user-select:none}
#wbPill:hover{background:rgba(0,0,0,.6);transform:translateX(-50%) scale(1.04)}
#wbDot{width:9px;height:9px;border-radius:50%;flex-shrink:0;transition:background 1.5s,box-shadow 1.5s}
#wbLabel{font-family:'Josefin Sans',sans-serif;font-weight:300;font-size:clamp(10px,1vw,13px);letter-spacing:.3em;text-transform:uppercase;color:rgba(255,255,255,.75)}
#wbSessionTime{font-family:'Share Tech Mono',monospace;font-size:clamp(10px,.9vw,12px);color:rgba(255,255,255,.35);letter-spacing:.1em;margin-left:4px}

/* â”€â”€ SOUND BTN â”€â”€ */
#soundBtn{position:fixed;top:clamp(16px,2.5vw,36px);right:clamp(16px,3vw,48px);z-index:9;pointer-events:all;cursor:pointer;background:rgba(0,0,0,.38);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,.14);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-size:14px;color:rgba(255,255,255,.5);transition:background .25s,color .25s,transform .15s}
#soundBtn:hover{background:rgba(0,0,0,.6);color:rgba(255,255,255,.9);transform:scale(1.1)}
#soundBtn.active{color:#fff;border-color:rgba(255,255,255,.4)}

/* â”€â”€ SKY INDICATOR (top-left) â”€â”€ */
#skyLabel{position:fixed;top:clamp(16px,2.5vw,36px);left:clamp(16px,3vw,48px);z-index:9;font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:clamp(9px,.9vw,12px);letter-spacing:.3em;text-transform:uppercase;color:rgba(255,255,255,.3);pointer-events:none;transition:color 2s}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WELLBEING PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#wbPanel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.92);z-index:20;width:min(540px,93vw);max-height:88vh;overflow-y:auto;background:rgba(6,6,10,.93);backdrop-filter:blur(36px);-webkit-backdrop-filter:blur(36px);border:1px solid rgba(255,255,255,.1);border-radius:18px;padding:32px;pointer-events:all;opacity:0;visibility:hidden;transition:opacity .3s,transform .3s,visibility .3s;scrollbar-width:none}
#wbPanel::-webkit-scrollbar{display:none}
#wbPanel.open{opacity:1;visibility:visible;transform:translate(-50%,-50%) scale(1)}
.wp-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.wp-title{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:11px;letter-spacing:.5em;text-transform:uppercase;color:rgba(255,255,255,.4)}
.wp-close{background:none;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.5);cursor:pointer;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;transition:background .2s,color .2s}
.wp-close:hover{background:rgba(255,255,255,.1);color:#fff}
.wb-state-card{border-radius:12px;padding:20px 24px;margin-bottom:20px;position:relative;overflow:hidden;border-top:2px solid transparent;transition:background 1.5s,border-top-color 1.5s}
.wb-state-card::before{content:'';position:absolute;inset:0;opacity:.06;background:radial-gradient(circle at 70% 30%,rgba(255,255,255,.8),transparent 60%);pointer-events:none}
.wb-state-name{font-family:'Playfair Display',serif;font-style:italic;font-size:clamp(22px,3vw,32px);color:#fff;line-height:1;margin-bottom:6px}
.wb-state-desc{font-family:'DM Sans',sans-serif;font-weight:300;font-size:12px;color:rgba(255,255,255,.6);line-height:1.5}
.wb-stats{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.wb-stat{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.07);border-radius:10px;padding:14px 16px}
.wb-stat-label{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:9px;letter-spacing:.4em;text-transform:uppercase;color:rgba(255,255,255,.3);margin-bottom:6px}
.wb-stat-value{font-family:'Share Tech Mono',monospace;font-size:20px;color:rgba(255,255,255,.85)}
.wb-rate-bars{display:flex;align-items:flex-end;gap:3px;height:28px;margin-top:4px}
.wb-rate-bar{flex:1;border-radius:2px;min-height:3px;transition:height .4s,background .4s}
.wb-mood-row{display:flex;gap:8px;flex-wrap:wrap}
.wb-mood-btn{flex:1;min-width:80px;padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.04);color:rgba(255,255,255,.5);font-family:'Josefin Sans',sans-serif;font-weight:300;font-size:10px;letter-spacing:.3em;text-transform:uppercase;cursor:pointer;transition:background .2s,border-color .2s,color .2s;display:flex;flex-direction:column;align-items:center;gap:4px}
.wb-mood-btn .mood-icon{font-size:16px}
.wb-mood-btn:hover{background:rgba(255,255,255,.1);color:rgba(255,255,255,.85)}
.section-divider{margin:20px 0;border-top:1px solid rgba(255,255,255,.06)}
.section-label{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:9px;letter-spacing:.4em;text-transform:uppercase;color:rgba(255,255,255,.3);margin-bottom:12px}

/* â”€â”€ AI POETRY IN PANEL â”€â”€ */
.panel-poem{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:16px 20px;min-height:56px;position:relative;overflow:hidden}
.panel-poem-text{font-family:'Cormorant Garamond',serif;font-style:italic;font-weight:300;font-size:15px;color:rgba(255,255,255,.7);line-height:1.6}
.panel-poem-loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center}
.poem-dots{display:flex;gap:5px}
.poem-dot{width:5px;height:5px;border-radius:50%;background:rgba(255,255,255,.2);animation:dotPulse 1.4s ease-in-out infinite}
.poem-dot:nth-child(2){animation-delay:.25s}
.poem-dot:nth-child(3){animation-delay:.5s}
@keyframes dotPulse{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}

/* â”€â”€ CONSTELLATION â”€â”€ */
.cosmos-section{margin-top:4px}
.cosmos-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.cosmos-title{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:10px;letter-spacing:.4em;text-transform:uppercase;color:rgba(255,255,255,.35)}
.cosmos-count{font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(255,255,255,.25)}
#constellCanvas{display:block;margin:0 auto;border-radius:50%;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.07)}
.cosmos-legend{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:9px;letter-spacing:.3em;text-transform:uppercase;color:rgba(255,255,255,.2);text-align:center;margin-top:8px}

/* â”€â”€ BREAK BANNER â”€â”€ */
#breakBanner{position:fixed;top:0;left:0;right:0;z-index:15;background:rgba(0,0,0,.9);backdrop-filter:blur(20px);padding:20px 32px;display:flex;align-items:center;justify-content:space-between;gap:16px;transform:translateY(-100%);transition:transform .5s cubic-bezier(.4,0,.2,1);border-bottom:1px solid rgba(255,255,255,.08)}
#breakBanner.show{transform:translateY(0)}
.break-msg{font-family:'DM Sans',sans-serif;font-weight:300;font-size:clamp(12px,1.5vw,15px);color:rgba(255,255,255,.7)}
.break-msg strong{color:#fff;font-weight:400}
#breakDismiss{pointer-events:all;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.7);cursor:pointer;padding:8px 20px;font-family:'Josefin Sans',sans-serif;font-weight:300;font-size:11px;letter-spacing:.3em;text-transform:uppercase;border-radius:2px;white-space:nowrap;transition:background .2s;flex-shrink:0}
#breakDismiss:hover{background:rgba(255,255,255,.18)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLOCK STYLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.clock-minimal-digital{top:clamp(16px,3vw,48px);right:clamp(16px,3vw,48px);text-align:right}
.clock-minimal-digital .time{font-family:'Share Tech Mono',monospace;font-size:clamp(36px,6vw,96px);color:#fff;letter-spacing:-.02em;line-height:1;text-shadow:0 0 40px rgba(255,255,255,.3)}
.clock-minimal-digital .date{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:clamp(10px,1vw,14px);color:rgba(255,255,255,.4);letter-spacing:.4em;text-transform:uppercase;margin-top:4px}
.clock-analog{bottom:clamp(80px,12vw,140px);left:50%;transform:translateX(-50%)}
.clock-analog canvas{display:block}
.clock-sundial{bottom:clamp(70px,10vw,130px);left:50%;transform:translateX(-50%)}
.clock-sundial canvas{display:block}
.clock-editorial{top:50%;left:clamp(16px,3vw,48px);transform:translateY(-50%)}
.clock-editorial .time{font-family:'Playfair Display',serif;font-style:italic;font-size:clamp(48px,8vw,130px);color:rgba(255,255,255,.9);line-height:.9;text-shadow:2px 4px 30px rgba(0,0,0,.6);writing-mode:vertical-rl;text-orientation:mixed;letter-spacing:-.05em}
.clock-editorial .date{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:clamp(8px,.9vw,12px);color:rgba(255,255,255,.4);letter-spacing:.35em;text-transform:uppercase;margin-top:12px;writing-mode:vertical-rl}
.clock-handwritten{bottom:clamp(80px,12vw,140px);left:clamp(16px,3vw,48px)}
.clock-handwritten .time{font-family:'Caveat',cursive;font-weight:700;font-size:clamp(52px,9vw,140px);color:rgba(255,255,255,.92);line-height:1;text-shadow:1px 2px 20px rgba(0,0,0,.5)}
.clock-handwritten .date{font-family:'Caveat',cursive;font-size:clamp(14px,1.8vw,24px);color:rgba(255,255,255,.5);margin-top:-4px}
.clock-brutalist{top:clamp(16px,3vw,48px);left:50%;transform:translateX(-50%);text-align:center}
.clock-brutalist .time{font-family:'Bebas Neue',sans-serif;font-size:clamp(60px,10vw,160px);color:#fff;letter-spacing:.08em;line-height:.85;-webkit-text-stroke:1px rgba(255,255,255,.5);text-shadow:4px 4px 0 rgba(0,0,0,.3)}
.clock-brutalist .date{font-family:'Bebas Neue',sans-serif;font-size:clamp(12px,1.5vw,20px);color:rgba(255,255,255,.35);letter-spacing:.3em;margin-top:2px}
.clock-roman{top:clamp(16px,3vw,48px);left:50%;transform:translateX(-50%);text-align:center;white-space:nowrap}
.clock-roman .time{font-family:'Cinzel',serif;font-weight:700;font-size:clamp(32px,5.5vw,88px);color:rgba(255,235,180,.95);letter-spacing:.15em;text-shadow:0 2px 20px rgba(180,130,0,.5)}
.clock-roman .date{font-family:'Cinzel',serif;font-weight:400;font-size:clamp(9px,1vw,13px);color:rgba(255,220,140,.45);letter-spacing:.4em;margin-top:6px}
.clock-whisper{bottom:clamp(80px,12vw,140px);right:clamp(16px,3vw,48px);text-align:right}
.clock-whisper .time{font-family:'Cormorant Garamond',serif;font-style:italic;font-weight:300;font-size:clamp(44px,7.5vw,120px);color:rgba(255,255,255,.85);line-height:1;letter-spacing:-.03em;text-shadow:0 2px 24px rgba(0,0,0,.4)}
.clock-whisper .date{font-family:'Cormorant Garamond',serif;font-size:clamp(11px,1.1vw,16px);color:rgba(255,255,255,.35);letter-spacing:.25em;margin-top:2px}
.clock-lcd{bottom:clamp(80px,12vw,140px);left:50%;transform:translateX(-50%);text-align:center;background:rgba(0,20,0,.55);border:1px solid rgba(0,255,100,.2);padding:clamp(8px,1.5vw,20px) clamp(16px,3vw,40px);backdrop-filter:blur(6px);border-radius:4px}
.clock-lcd .time{font-family:'Share Tech Mono',monospace;font-size:clamp(36px,6vw,96px);color:#3f9;text-shadow:0 0 8px #3f9,0 0 20px rgba(0,255,100,.4);letter-spacing:.1em;line-height:1}
.clock-lcd .date{font-family:'Share Tech Mono',monospace;font-size:clamp(10px,1vw,13px);color:rgba(51,255,153,.45);letter-spacing:.3em;margin-top:4px}
.clock-split{top:clamp(16px,3vw,48px);right:clamp(16px,3vw,48px);text-align:right}
.clock-split .hours{font-family:'Righteous',cursive;font-size:clamp(64px,11vw,180px);color:#fff;line-height:.85;text-shadow:3px 3px 0 rgba(0,0,0,.25);letter-spacing:-.04em}
.clock-split .mins{font-family:'Righteous',cursive;font-size:clamp(64px,11vw,180px);color:transparent;-webkit-text-stroke:2px rgba(255,255,255,.5);line-height:.85;letter-spacing:-.04em}
.clock-split .date{font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:clamp(9px,.9vw,13px);color:rgba(255,255,255,.35);letter-spacing:.4em;text-transform:uppercase;margin-top:6px}
</style>
</head>
<body>

<canvas id="skyCanvas"></canvas>
<div id="loadBar"></div>
<div id="bg"></div>
<canvas id="inkCanvas"></canvas>
<canvas id="ambientCanvas"></canvas>
<div id="moodTint"></div>
<div class="overlay"></div>
<canvas id="spectrumCanvas"></canvas>
<div id="colorBar"></div>

<div id="breakBanner">
  <div class="break-msg">ğŸŒ¿ <strong>You've been active a while.</strong> Digital Wellbeing suggests a short break â€” switching to restorative imagery.</div>
  <button id="breakDismiss">Dismiss</button>
</div>

<div id="wbPill"><div id="wbDot"></div><span id="wbLabel">Loading</span><span id="wbSessionTime">0:00</span></div>
<button id="soundBtn" title="Toggle Nature &amp; Chroma Sounds">â™ª</button>
<div id="skyLabel"></div>
<div id="natureSoundLabel" style="position:fixed;top:clamp(58px,8vw,80px);right:clamp(16px,3vw,48px);z-index:9;font-family:'Josefin Sans',sans-serif;font-weight:100;font-size:clamp(8px,.85vw,11px);letter-spacing:.35em;text-transform:uppercase;color:rgba(255,255,255,.45);pointer-events:none;opacity:0;transition:opacity 1.8s ease;text-align:right;text-shadow:0 1px 8px rgba(0,0,0,.7)"></div>

<!-- Floating AI Poetry -->
<div id="poetryDisplay"><span class="poetry-line" id="pLine1"></span><span class="poetry-line" id="pLine2"></span></div>

<div id="clockWrap" class="hidden"></div>

<!-- Wellbeing Panel -->
<div id="wbPanel">
  <div class="wp-header">
    <span class="wp-title">âœ¦ Chromatic Cosmos</span>
    <button class="wp-close" id="wbPanelClose">âœ•</button>
  </div>
  <div class="wb-state-card" id="wbStateCard">
    <div class="wb-state-name" id="wbStateName">â€“</div>
    <div class="wb-state-desc" id="wbStateDesc">â€“</div>
  </div>
  <div class="wb-stats">
    <div class="wb-stat"><div class="wb-stat-label">Session time</div><div class="wb-stat-value" id="wbPanelTime">0:00</div></div>
    <div class="wb-stat"><div class="wb-stat-label">Photos seen</div><div class="wb-stat-value" id="wbPanelCount">0</div></div>
    <div class="wb-stat"><div class="wb-stat-label">Hour of day</div><div class="wb-stat-value" id="wbPanelHour">â€“</div></div>
    <div class="wb-stat"><div class="wb-stat-label">Interaction rate</div><div class="wb-stat-value" id="wbPanelRate">â€“</div><div class="wb-rate-bars" id="wbRateBars"></div></div>
  </div>
  <div style="margin-bottom:4px"><div class="wb-stat-label" style="margin-bottom:10px">Override mood</div><div class="wb-mood-row" id="wbMoodRow"></div></div>
  <!-- AI Poetry in panel -->
  <div class="section-divider"></div>
  <div class="section-label">AI Chromatic Poem Â· current photo</div>
  <div class="panel-poem" id="panelPoem">
    <div class="panel-poem-loader" id="poemLoader"><div class="poem-dots"><div class="poem-dot"></div><div class="poem-dot"></div><div class="poem-dot"></div></div></div>
    <div class="panel-poem-text" id="panelPoemText" style="display:none"></div>
  </div>
  <!-- Session Constellation -->
  <div class="section-divider"></div>
  <div class="cosmos-section">
    <div class="cosmos-header"><span class="cosmos-title">Session Cosmos</span><span class="cosmos-count" id="cosmosCount">0 photos charted</span></div>
    <canvas id="constellCanvas" width="240" height="240"></canvas>
    <div class="cosmos-legend">âœ¦ position = dominant hue Â· size = brightness Â· order = visit sequence</div>
  </div>
</div>

<div class="ui">
  <div class="top">
    <div class="brand">Gallery Â· Cosmos</div>
    <div class="img-count" id="imgCount">â€” / â€”</div>
  </div>
  <div class="bottom">
    <div class="photo-info">
      <div class="photo-author" id="photoAuthor"></div>
      <div class="photo-id" id="photoId"></div>
      <!-- Emotional Radar Fingerprint -->
      <div id="emotionRadar"><canvas id="radarCanvas" width="110" height="110"></canvas></div>
    </div>
    <button id="nextBtn">
      Double-tap anywhere
      <svg viewBox="0 0 24 24"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>
    </button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UNSPLASH PHOTO POOLS â€” curated by wellbeing state
//  Direct CDN URLs (no API key needed, CORS-enabled)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const UNSPLASH = {
  calm: [
    '1506905925346-21bda4d32df4','1472214103451-9374f6ad3abe','1501854140801-50d01698950b',
    '1518770660439-4636190af475','1476610182048-b1dc5b531bab','1500534314209-a157d0e84df4',
    '1441974231531-c6227db76b6e','1490750967868-88df5691240e','1518020382113-a7ef8d3f1e38',
    '1504701954957-2010ec3bcec1','1469474968028-56623f02e42e','1434725670-2098f07e91ec',
    '1507003211169-0a1dd7228f2d','1519681393784-d120267933ba','1507525428034-b723cf961d3e',
    '1455218873509-8d23e3a817b7','1504198266287-1659872e6590','1491555103944-7c647fd857e6',
  ],
  focused: [
    '1486325212027-8081e485255e','1477959858617-67f85cf4f1df','1449844908441-ef7f5f709cce',
    '1497366216548-37526070297c','1520607162513-77705c0f0d4a','1486754735734-325b5831c3ad',
    '1460400408855-36abd76648b9','1473163164194-d0bc27ba2ffe','1518005020951-eccb494ad742',
    '1494783367685-92f600684f83','1461896836374-f3322d279b10','1449495169669-7b118f960251',
    '1506259091721-347e791bab0f','1507679799987-c73779587ccf','1502136969935-8d8eef54d77b',
  ],
  energized: [
    '1533461620780-fc5ebb4e8f90','1508739773434-c26b3d09e071','1490730161803-4eb1c01d4a67',
    '1543722530-d4850de5fbac','1504639725590-34d0984388bd','1518709268805-4e9042af9f23',
    '1551632436-cbf8dd35adfa','1548199973-03cce0bbc87b','1505765050516-f72dc64a53a1',
    '1534528741775-53994a69daeb','1549880338-65ddcdfd017b','1566024287286-457247b70310',
    '1520004434144-f32d5fcc8a49','1488161628813-04466f872be2','1493238792000-8113da705763',
  ],
  windDown: [
    '1505765050516-f72dc64a53a1','1519681393784-d120267933ba','1490730161803-4eb1c01d4a67',
    '1504198266287-1659872e6590','1510798831971-d929f2c9e5db','1507003211169-0a1dd7228f2d',
    '1464822759023-fed622ff2c3b','1478760329108-5c3ed9d495a0','1500534314209-a157d0e84df4',
    '1432163645000-2a43a56d8c1e','1519058082350-5b924c36f4ae','1524685794168-52985e79d4a7',
    '1492684223066-81342ee5ff30','1500382017468-9049fed747ef','1449496195821-b9b9fc4f6890',
  ],
  restore: [
    '1448375240819-6a2b9ce95cb5','1501744466-e4d9d80048cb','1518531933037-91b2f5f229cc',
    '1441974231531-c6227db76b6e','1518155317743-a8ff43ea6a5f','1476673160081-cf065607f449',
    '1511497584788-876760111969','1530908295418-a12e326966ba','1505471768190-275e2ad9fb3f',
    '1469474968028-56623f02e42e','1461354464878-ad92f384b07a','1502082553048-f009b37129b2',
    '1504239220737-b9a6dc0dcf05','1518780664697-55e3ad937233','1500468756920-b6a85e46371d',
    '1540206395-68808572332f','1513836279014-a89f7a76ae86','1510797215324-721bb9711bd5',
  ],
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WELLBEING STATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WB={
  calm:     {name:'Calm',      icon:'ğŸŒ…',desc:'Morning energy. Soft landscapes and serene nature ease you in.',               color:'#6ab8e8',rgb:[106,184,232],tint:'rgba(91,164,207,.07)',  bd:15,amb:{n:18,spd:.4,col:[160,210,255],shape:'orb',  sine:true, op:.32,lMin:200,lMax:380}},
  focused:  {name:'Focused',   icon:'ğŸ¯',desc:'Peak productivity. Clean architecture and minimal forms sharpen attention.',   color:'#e8c87a',rgb:[232,200,122],tint:'rgba(232,200,122,.06)',bd:10,amb:{n:12,spd:.7,col:[255,218,100],shape:'diamond',sine:false,op:.38,lMin:140,lMax:260}},
  energized:{name:'Energized', icon:'âš¡',desc:'High activity. Vivid scenes and dynamic bursts match your energy.',          color:'#f0623a',rgb:[240,98,58], tint:'rgba(240,98,58,.07)',  bd:7, amb:{n:30,spd:2.8,col:[255,110,55],shape:'spark',sine:false,op:.48,lMin:28, lMax:72}},
  windDown: {name:'Wind Down', icon:'ğŸŒ‡',desc:'Evening settling in. Warm tones and twilight scenes ease the transition.',    color:'#d4845a',rgb:[212,132,90],tint:'rgba(196,125,84,.09)', bd:14,amb:{n:16,spd:.3,col:[255,175,90],shape:'ember',sine:false,op:.36,lMin:220,lMax:420}},
  restore:  {name:'Restore',   icon:'ğŸŒ¿',desc:'Extended screen time. Restorative greens and natural scenes reset focus.',   color:'#5cbf7e',rgb:[92,191,126], tint:'rgba(92,191,126,.08)', bd:18,amb:{n:22,spd:.28,col:[100,210,150],shape:'mote',sine:true, op:.30,lMin:280,lMax:480}},
};

const session={startTime:Date.now(),totalInteractions:0,recentInteractions:[],currentState:'calm',manualOverride:null,imgCount:0,rateHistory:Array(8).fill(0)};
let imgPool=[],clockPool=[],activeClockStyle=null,clockTimer=null;
let analCanvas=null,analCtx=null,sundialCanvas=null,sundialCtx=null;
let panelOpen=false,breakShown=false;
const BREAK_MS=25*60*1000,MAX_COLOR_HIST=60;
let moodColor={r:106,g:184,b:232},moodTarget={r:106,g:184,b:232};
let currentPalette=[[106,184,232]],colorHistory=[],constellStars=[],constellAngle=0;

// â”€â”€ WELLBEING LOGIC â”€â”€
function getTimeState(){const h=new Date().getHours();return h>=5&&h<10?'calm':h>=10&&h<14?'focused':h>=14&&h<18?'energized':h>=18&&h<22?'windDown':'restore'}
function getRate(){const n=Date.now();return session.recentInteractions.filter(t=>n-t<120000).length}
function recordInteraction(){const n=Date.now();session.totalInteractions++;session.recentInteractions.push(n);session.recentInteractions=session.recentInteractions.filter(t=>n-t<1200000);session.rateHistory.push(getRate());if(session.rateHistory.length>8)session.rateHistory.shift()}
function computeState(){if(session.manualOverride)return session.manualOverride;const m=(Date.now()-session.startTime)/60000,r=getRate();if(m>20)return'restore';if(r>=5)return'energized';if(r>=2)return'focused';return getTimeState()}

function updateWbUI(){
  const state=computeState();session.currentState=state;
  const cfg=WB[state];
  const el=Math.floor((Date.now()-session.startTime)/1000);
  const tStr=`${Math.floor(el/60)}:${String(el%60).padStart(2,'0')}`;
  const rate=getRate();
  document.getElementById('wbDot').style.cssText=`background:${cfg.color};box-shadow:0 0 8px ${cfg.color}`;
  document.getElementById('wbLabel').textContent=cfg.name;
  document.getElementById('wbSessionTime').textContent=tStr;
  document.getElementById('loadBar').style.background=cfg.color;
  document.getElementById('moodTint').style.background=cfg.tint;
  document.querySelector('.overlay').style.setProperty('--bd',`${cfg.bd}s`);
  document.getElementById('wbPanelTime').textContent=tStr;
  document.getElementById('wbPanelCount').textContent=session.imgCount;
  document.getElementById('wbPanelHour').textContent=`${new Date().getHours()}h`;
  document.getElementById('wbPanelRate').textContent=`${rate}/2m`;
  const card=document.getElementById('wbStateCard');
  card.style.background=`${cfg.color}18`;card.style.borderTopColor=`${cfg.color}66`;
  document.getElementById('wbStateName').textContent=`${cfg.icon}  ${cfg.name}`;
  document.getElementById('wbStateDesc').textContent=cfg.desc;
  const maxR=Math.max(...session.rateHistory,1);
  document.getElementById('wbRateBars').innerHTML=session.rateHistory.map(v=>`<div class="wb-rate-bar" style="height:${Math.max(8,(v/maxR)*100)}%;background:${cfg.color}99"></div>`).join('');
  document.querySelectorAll('.wb-mood-btn').forEach(b=>{const a=b.dataset.state===state,c=WB[b.dataset.state].color;b.style.background=a?`${c}28`:'';b.style.borderColor=a?`${c}70`:'';b.style.color=a?'#fff':''});
  ambSetState(state);
  moodTarget={r:cfg.rgb[0],g:cfg.rgb[1],b:cfg.rgb[2]};
  if(!breakShown&&(Date.now()-session.startTime)>BREAK_MS){breakShown=true;document.getElementById('breakBanner').classList.add('show');if(!session.manualOverride)session.manualOverride='restore';setTimeout(updateWbUI,100)}
}

function buildMoodButtons(){const row=document.getElementById('wbMoodRow');Object.entries(WB).forEach(([k,c])=>{const b=document.createElement('button');b.className='wb-mood-btn';b.dataset.state=k;b.innerHTML=`<span class="mood-icon">${c.icon}</span>${c.name}`;b.addEventListener('click',()=>{session.manualOverride=session.manualOverride===k?null:k;updateWbUI()});row.appendChild(b)})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â‘  CIRCADIAN SKY ENGINE
//     Preetham-inspired atmospheric scattering simulation.
//     Renders the physically accurate sky color for current time,
//     complete with stars at night, golden corona at sunrise/sunset,
//     and solar position. Updates every 60s, transitions smoothly.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const skyCanvas=document.getElementById('skyCanvas');
const skyCtx=skyCanvas.getContext('2d');
let skyPhase=0; // for star twinkle

function resizeSky(){skyCanvas.width=innerWidth;skyCanvas.height=innerHeight}
resizeSky();

// Sky color stops for each hour 0-23
const SKY_HOURS=[
  [0,  [[10,5,22],[15,8,32],[5,3,15]]],    // midnight â€” deep violet-black
  [3,  [[5,3,12],[12,6,25],[3,2,10]]],     // 3am â€” near black
  [5,  [[40,20,60],[80,40,90],[20,10,40]]],// 5am â€” pre-dawn purple
  [6,  [[200,100,60],[255,160,80],[120,60,40]]], // 6am â€” golden sunrise
  [7,  [[220,140,80],[255,190,120],[160,100,60]]], // 7am â€” morning gold
  [9,  [[100,160,230],[140,190,255],[70,130,200]]], // 9am â€” soft morning blue
  [12, [[40,110,200],[80,150,240],[20,80,180]]], // noon â€” deep blue
  [15, [[60,130,210],[100,165,245],[40,100,190]]], // 3pm â€” afternoon blue
  [17, [[200,120,60],[255,170,80],[150,80,40]]], // 5pm â€” golden hour
  [18, [[220,80,50],[255,120,60],[180,50,30]]], // 6pm â€” sunset red
  [19, [[180,60,80],[220,90,100],[140,40,60]]], // 7pm â€” dusk pink-purple
  [20, [[60,30,80],[90,50,110],[40,20,60]]], // 8pm â€” twilight
  [21, [[20,15,45],[35,25,65],[10,8,30]]], // 9pm â€” early night
  [23, [[8,4,18],[14,8,28],[4,2,10]]],     // 11pm â†’ midnight
];

function lerpRGB(c1,c2,t){return[c1[0]+(c2[0]-c1[0])*t,c1[1]+(c2[1]-c1[1])*t,c1[2]+(c2[2]-c1[2])*t]}

function getSkyColors(){
  const now=new Date();
  const fh=now.getHours()+now.getMinutes()/60;
  let i=0;
  for(let j=0;j<SKY_HOURS.length-1;j++){if(fh>=SKY_HOURS[j][0]&&fh<SKY_HOURS[j+1][0]){i=j;break}}
  const h0=SKY_HOURS[i],h1=SKY_HOURS[(i+1)%SKY_HOURS.length];
  const span=h1[0]>h0[0]?h1[0]-h0[0]:24-h0[0]+h1[0];
  const t=((fh-h0[0]+24)%24)/span;
  return h0[1].map((c,ci)=>lerpRGB(c,h1[1][ci],t));
}

function getSunPosition(){
  const now=new Date();
  const fh=now.getHours()+now.getMinutes()/60;
  const progress=(fh-6)/12; // 0=6am, 1=6pm
  const angle=Math.PI+progress*Math.PI; // PIâ†’2PI (leftâ†’right through top)
  const W=skyCanvas.width,H=skyCanvas.height;
  const cx=W/2,cy=H*0.65,R=Math.min(W,H)*0.55;
  return{x:cx+Math.cos(angle)*R,y:cy+Math.sin(angle)*R,visible:progress>0&&progress<1,progress};
}

let stars=null;
function initStars(){
  const W=skyCanvas.width,H=skyCanvas.height;
  stars=Array.from({length:220},()=>({x:Math.random()*W,y:Math.random()*H*.65,r:.4+Math.random()*1.2,phase:Math.random()*Math.PI*2}));
}
initStars();

function drawSky(){
  const W=skyCanvas.width,H=skyCanvas.height;
  const cols=getSkyColors();
  // Gradient: top â†’ bottom
  const grad=skyCtx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0,`rgb(${cols[0].map(Math.round).join(',')})`);
  grad.addColorStop(0.6,`rgb(${cols[1].map(Math.round).join(',')})`);
  grad.addColorStop(1,`rgb(${cols[2].map(Math.round).join(',')})`);
  skyCtx.fillStyle=grad;skyCtx.fillRect(0,0,W,H);

  // Stars â€” only visible when sky is dark
  const lum=(cols[0][0]+cols[0][1]+cols[0][2])/3;
  const starAlpha=Math.max(0,Math.min(1,(50-lum)/45));
  if(starAlpha>0.01&&stars){
    skyPhase+=0.008;
    stars.forEach(s=>{
      const twinkle=.5+.5*Math.sin(s.phase+skyPhase);
      skyCtx.globalAlpha=starAlpha*(.4+.6*twinkle);
      skyCtx.beginPath();skyCtx.arc(s.x,s.y,s.r*(0.7+.3*twinkle),0,Math.PI*2);
      skyCtx.fillStyle='#fff';skyCtx.fill();
    });
    skyCtx.globalAlpha=1;
  }

  // Sun
  const sun=getSunPosition();
  if(sun.visible&&sun.y<H*0.9){
    const dusk=Math.abs(sun.progress-.5)*2; // 0=noon, 1=horizon
    const sunR=Math.round(255), sunG=Math.round(220-dusk*80), sunB=Math.round(150-dusk*100);
    // Corona halo
    const haloR=Math.min(W,H)*.08;
    const hl=skyCtx.createRadialGradient(sun.x,sun.y,0,sun.x,sun.y,haloR*3.5);
    hl.addColorStop(0,`rgba(${sunR},${sunG},${sunB},.35)`);
    hl.addColorStop(0.4,`rgba(${sunR},${sunG},${Math.max(0,sunB-30)},.12)`);
    hl.addColorStop(1,'rgba(0,0,0,0)');
    skyCtx.beginPath();skyCtx.arc(sun.x,sun.y,haloR*3.5,0,Math.PI*2);skyCtx.fillStyle=hl;skyCtx.fill();
    // Sun disc
    const sl=skyCtx.createRadialGradient(sun.x,sun.y,0,sun.x,sun.y,haloR);
    sl.addColorStop(0,'rgba(255,255,240,1)');sl.addColorStop(.4,`rgba(${sunR},${sunG},${sunB},.9)`);sl.addColorStop(1,'rgba(255,200,100,0)');
    skyCtx.beginPath();skyCtx.arc(sun.x,sun.y,haloR,0,Math.PI*2);skyCtx.fillStyle=sl;skyCtx.fill();
  }

  // Horizon ground haze
  const haze=skyCtx.createLinearGradient(0,H*.6,0,H);
  haze.addColorStop(0,'rgba(0,0,0,0)');haze.addColorStop(1,'rgba(0,0,0,.55)');
  skyCtx.fillStyle=haze;skyCtx.fillRect(0,H*.6,W,H*.4);

  // Update sky label
  const h=new Date().getHours();
  const labels={5:'Dawn',6:'Sunrise',7:'Morning',9:'Mid-morning',12:'Noon',14:'Afternoon',17:'Golden Hour',18:'Sunset',19:'Dusk',20:'Twilight',21:'Night',23:'Midnight'};
  let label='Night'; for(const [hr,lbl] of Object.entries(labels)){if(h>=+hr)label=lbl}
  document.getElementById('skyLabel').textContent=label;
}

function skyLoop(){drawSky();requestAnimationFrame(skyLoop)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â‘¡ COLOR DNA EXTRACTOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const probeCanvas=document.createElement('canvas');probeCanvas.width=probeCanvas.height=80;
const probeCtx=probeCanvas.getContext('2d');

async function extractColors(id){
  return new Promise(resolve=>{
    const img=new Image();img.crossOrigin='anonymous';
    img.onload=()=>{
      try{
        probeCtx.drawImage(img,0,0,80,80);
        const data=probeCtx.getImageData(0,0,80,80).data;
        const buckets=Array.from({length:36},()=>({r:0,g:0,b:0,n:0,lSum:0}));
        for(let i=0;i<data.length;i+=4){
          const r=data[i],g=data[i+1],b=data[i+2];
          const mx=Math.max(r,g,b),mn=Math.min(r,g,b),d=mx-mn;
          if(d<18||mx<25)continue;
          let h=0;
          if(mx===r)h=((g-b)/d+6)%6;
          else if(mx===g)h=(b-r)/d+2;
          else h=(r-g)/d+4;
          const bi=Math.floor(h*6)%36;
          const lum=(.299*r+.587*g+.114*b)/255;
          buckets[bi].r+=r;buckets[bi].g+=g;buckets[bi].b+=b;buckets[bi].n++;buckets[bi].lSum+=lum;
        }
        const pal=buckets.filter(bk=>bk.n>8).sort((a,b)=>b.n-a.n).slice(0,5)
          .map(bk=>[Math.round(bk.r/bk.n),Math.round(bk.g/bk.n),Math.round(bk.b/bk.n),bk.lSum/bk.n]);
        resolve(pal.length>0?pal:null);
      }catch{resolve(null)}
    };
    img.onerror=()=>resolve(null);
    img.src=`https://images.unsplash.com/photo-${id}?auto=format&fit=crop&w=80&h=80&q=60`;
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â‘¢ AI CHROMATIC POETRY ENGINE  (Claude API)
//     Generates a unique 2-line poem for every photo based on:
//     Â· Dominant color (hue description)
//     Â· Photographer name
//     Â· Current wellbeing state
//     Â· Time of day
//     Poetry floats at bottom-center and inside the panel.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentPoem='';

function rgbToHueName([r,g,b]){
  const mx=Math.max(r,g,b),mn=Math.min(r,g,b),d=mx-mn;
  if(d<20)return r>200?'white':r<60?'black':'grey';
  let h=mx===r?((g-b)/d+6)%6:mx===g?(b-r)/d+2:(r-g)/d+4;
  h=h/6;
  if(h<.033)return'crimson';if(h<.083)return'vermillion';if(h<.15)return'amber';
  if(h<.2)return'gold';if(h<.25)return'chartreuse';if(h<.38)return'emerald';
  if(h<.5)return'teal';if(h<.62)return'cerulean';if(h<.72)return'cobalt';
  if(h<.8)return'indigo';if(h<.9)return'violet';return'magenta';
}

async function generatePoem(palette,info,state){
  if(!palette||!palette[0])return null;
  const hue=rgbToHueName(palette[0]);
  const brightness=palette[0][3]>.55?'luminous':palette[0][3]>.35?'muted':'shadowed';
  const author=info?.author||'unknown';
  const hour=new Date().getHours();
  const timeWord=hour<6?'nocturne':hour<10?'dawn':hour<14?'noon':hour<18?'afternoon':hour<20?'dusk':'night';
  const prompt=`You are a minimalist poet. Write exactly 2 lines of evocative, imagistic poetry â€” no more than 9 words per line. Base it on: dominant color "${hue}" (${brightness}), mood "${state}", time "${timeWord}", photographer "${author}". Output ONLY the 2 lines, nothing else, no title, no punctuation at line end except natural pauses.`;
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:80,messages:[{role:'user',content:prompt}]})
    });
    const d=await res.json();
    return d.content?.[0]?.text?.trim()||null;
  }catch{return null}
}

function displayPoem(text){
  currentPoem=text||'';
  const pd=document.getElementById('poetryDisplay');
  const lines=(text||'').split('\n').filter(l=>l.trim()).slice(0,2);
  if(lines.length<2){pd.classList.remove('visible');return}
  pd.classList.remove('visible');
  document.getElementById('pLine1').textContent=lines[0]||'';
  document.getElementById('pLine2').textContent=lines[1]||'';
  setTimeout(()=>pd.classList.add('visible'),800);
  // Also update panel
  const pl=document.getElementById('poemLoader'),pt=document.getElementById('panelPoemText');
  pl.style.display='none';pt.style.display='block';
  pt.textContent=lines.join('\n');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â‘£ EMOTIONAL RADAR FINGERPRINT
//     5-axis radar chart computed from color DNA:
//     Warmth Â· Serenity Â· Vitality Â· Depth Â· Mystery
//     Unique per photo â€” appears bottom-left as a holographic badge
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const RADAR_AXES=['Warmth','Serenity','Vitality','Depth','Mystery'];

function computeEmotions(palette){
  if(!palette||!palette[0])return[.5,.5,.5,.5,.5];
  const vals=palette.map(([r,g,b,l=.5])=>{
    const mx=Math.max(r,g,b)/255,mn=Math.min(r,g,b)/255,d=mx-mn;
    let h=0;
    if(d>.05){if(mx===r/255)h=((g-b)/255/d+6)%6;else if(mx===g/255)h=(b-r)/255/d+2;else h=(r-g)/255/d+4;h=h/6}
    return{r:r/255,g:g/255,b:b/255,h,s:mx>0?d/mx:0,v:mx,lum:l||(.299*r+.587*g+.114*b)/255};
  });
  const mean=arr=>arr.reduce((a,b)=>a+b,0)/arr.length;
  const warmth=mean(vals.map(v=>v.h<.16||v.h>.92?v.s*v.v:0));
  const serenity=mean(vals.map(v=>v.h>.5&&v.h<.72?v.s*.5+v.v*.5:0));
  const vitality=mean(vals.map(v=>v.s));
  const depth=1-mean(vals.map(v=>v.lum));
  const mystery=mean(vals.map(v=>v.lum<.25?1:0));
  return[Math.min(1,warmth*2.2),Math.min(1,serenity*2),Math.min(1,vitality),Math.min(1,depth),Math.min(1,mystery*3)];
}

function drawRadar(palette){
  const cvs=document.getElementById('radarCanvas'),ctx=cvs.getContext('2d');
  const W=cvs.width,H=cvs.height,cx=W/2,cy=H/2,R=Math.min(W,H)/2-12;
  ctx.clearRect(0,0,W,H);
  const scores=computeEmotions(palette);
  const n=5,angleStep=Math.PI*2/n,startAngle=-Math.PI/2;
  // Get dominant color for tinting
  const [r,g,b]=palette[0];
  // Background web
  ctx.save();
  [.25,.5,.75,1].forEach(ring=>{
    ctx.beginPath();
    for(let i=0;i<n;i++){const a=startAngle+i*angleStep,pr=ring*R;ctx.i===0?ctx.moveTo(cx+Math.cos(a)*pr,cy+Math.sin(a)*pr):ctx.lineTo(cx+Math.cos(a)*pr,cy+Math.sin(a)*pr)}
    ctx.closePath();
    ctx.strokeStyle=`rgba(255,255,255,${ring===1?.18:.08})`;ctx.lineWidth=.8;ctx.stroke();
  });
  // Spokes
  for(let i=0;i<n;i++){const a=startAngle+i*angleStep;ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(a)*R,cy+Math.sin(a)*R);ctx.strokeStyle='rgba(255,255,255,.1)';ctx.lineWidth=.8;ctx.stroke()}
  // Score polygon â€” filled with extracted photo color
  ctx.beginPath();
  scores.forEach((s,i)=>{const a=startAngle+i*angleStep,pr=s*R;i===0?ctx.moveTo(cx+Math.cos(a)*pr,cy+Math.sin(a)*pr):ctx.lineTo(cx+Math.cos(a)*pr,cy+Math.sin(a)*pr)});
  ctx.closePath();
  const grad=ctx.createRadialGradient(cx,cy,0,cx,cy,R);
  grad.addColorStop(0,`rgba(${r},${g},${b},.55)`);
  grad.addColorStop(1,`rgba(${r},${g},${b},.12)`);
  ctx.fillStyle=grad;ctx.fill();
  ctx.strokeStyle=`rgba(${r},${g},${b},.85)`;ctx.lineWidth=1.5;ctx.stroke();
  // Axis labels
  ctx.font='100 7px "Josefin Sans",sans-serif';ctx.fillStyle='rgba(255,255,255,.38)';ctx.textAlign='center';ctx.textBaseline='middle';
  RADAR_AXES.forEach((lbl,i)=>{
    const a=startAngle+i*angleStep,d=R+10;
    ctx.fillText(lbl.slice(0,3).toUpperCase(),cx+Math.cos(a)*d,cy+Math.sin(a)*d);
  });
  // Score dots
  scores.forEach((s,i)=>{const a=startAngle+i*angleStep,pr=s*R;ctx.beginPath();ctx.arc(cx+Math.cos(a)*pr,cy+Math.sin(a)*pr,2.2,0,Math.PI*2);ctx.fillStyle=`rgba(${r},${g},${b},1)`;ctx.fill()});
  ctx.restore();
  document.getElementById('emotionRadar').classList.add('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â‘¤ MOUSE/GYRO PARALLAX DEPTH
//     The wallpaper photo subtly shifts as mouse moves or device
//     tilts â€” creating a window-into-another-world depth illusion.
//     Max shift = 2.2% of viewport (photo is oversized by 8% to cover)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let targetPX=0,targetPY=0,currentPX=0,currentPY=0;
const PARALLAX_STRENGTH=2.2; // percent of viewport

function applyParallax(){
  currentPX+=(targetPX-currentPX)*.07;
  currentPY+=(targetPY-currentPY)*.07;
  document.getElementById('bg').style.transform=`translate(${currentPX}%,${currentPY}%)`;
  requestAnimationFrame(applyParallax);
}

document.addEventListener('mousemove',e=>{
  targetPX=((e.clientX/innerWidth)-.5)*-PARALLAX_STRENGTH;
  targetPY=((e.clientY/innerHeight)-.5)*-PARALLAX_STRENGTH;
});

// Device orientation (gyroscope â€” works on mobile)
window.addEventListener('deviceorientation',e=>{
  if(e.beta==null)return;
  targetPX=Math.max(-3,Math.min(3,(e.gamma||0)/18*-PARALLAX_STRENGTH));
  targetPY=Math.max(-3,Math.min(3,((e.beta||0)-30)/30*-PARALLAX_STRENGTH));
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  â‘¥ FFT SPECTRUM HALO  (Web Audio AnalyserNode)
//     When Chroma Sound is on, the frequency spectrum paints
//     a living ring around the sundial / center of screen.
//     Each frequency bin = one point on the ring, colored by
//     the extracted photo palette hue at that frequency range.
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const specCanvas=document.getElementById('spectrumCanvas');
const specCtx=specCanvas.getContext('2d');
let analyser=null,freqData=null;

function resizeSpec(){specCanvas.width=innerWidth;specCanvas.height=innerHeight}
resizeSpec();

function drawSpectrumHalo(){
  const W=specCanvas.width,H=specCanvas.height;
  specCtx.clearRect(0,0,W,H);
  if(!analyser||!freqData||!soundEnabled)return;
  analyser.getByteFrequencyData(freqData);
  const cx=W/2,cy=H/2;
  const R0=Math.min(W,H)*.19, R1=Math.min(W,H)*.28;
  const bins=freqData.length;
  const n=bins; // one point per bin
  const [r0,g0,b0]=currentPalette[0]||[150,180,255];
  const [r1,g1,b1]=(currentPalette[1]||currentPalette[0]||[100,200,150]);
  specCtx.save();
  // Outer glow ring (slow rotation)
  const rotOffset=(Date.now()/5000)*Math.PI*2;
  for(let i=0;i<n;i++){
    const a=(i/n)*Math.PI*2+rotOffset;
    const v=freqData[i]/255;
    if(v<.04)continue;
    const rInner=R0,rOuter=R0+(R1-R0)*v;
    const t=i/n;
    const ri=Math.round(r0+(r1-r0)*t),gi=Math.round(g0+(g1-g0)*t),bi=Math.round(b0+(b1-b0)*t);
    specCtx.beginPath();
    specCtx.moveTo(cx+Math.cos(a)*rInner,cy+Math.sin(a)*rInner);
    specCtx.lineTo(cx+Math.cos(a)*rOuter,cy+Math.sin(a)*rOuter);
    specCtx.strokeStyle=`rgba(${ri},${gi},${bi},${.5+v*.5})`;
    specCtx.lineWidth=1.8;specCtx.lineCap='round';specCtx.stroke();
  }
  // Inner glow circle
  const avg=freqData.reduce((a,b)=>a+b,0)/n/255;
  if(avg>.06){
    const gl=specCtx.createRadialGradient(cx,cy,R0*.6,cx,cy,R0);
    gl.addColorStop(0,`rgba(${r0},${g0},${b0},${avg*.18})`);
    gl.addColorStop(1,`rgba(${r0},${g0},${b0},0)`);
    specCtx.beginPath();specCtx.arc(cx,cy,R0,0,Math.PI*2);specCtx.fillStyle=gl;specCtx.fill();
  }
  specCtx.restore();
}

function specLoop(){drawSpectrumHalo();requestAnimationFrame(specLoop)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AMBIENT PARTICLE SYSTEM + ECHO RIPPLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ambCanvas=document.getElementById('ambientCanvas');
const ambCtx=ambCanvas.getContext('2d');
let particles=[],ripples=[];
let ambCfg=WB.calm.amb;

function resizeAmb(){ambCanvas.width=innerWidth;ambCanvas.height=innerHeight}
resizeAmb();
window.addEventListener('resize',()=>{resizeSky();resizeAmb();resizeSpec();initStars()});

function ambSetState(s){ambCfg=WB[s].amb}

function addRipples(palette){
  const cx=ambCanvas.width/2,cy=ambCanvas.height/2;
  const maxR=Math.sqrt(cx*cx+cy*cy)*1.05;
  for(let i=0;i<4;i++){const[r,g,b]=(palette[i%palette.length])||[200,200,200];ripples.push({x:cx,y:cy,r:30+i*45,maxR,spd:14+i*2,r_rgb:r,g_rgb:g,b_rgb:b,alpha:.55-i*.1})}
}

function spawnParticle(){
  const W=ambCanvas.width,H=ambCanvas.height,cfg=ambCfg;
  const pi=Math.floor(Math.random()*currentPalette.length);
  const [r,g,b]=currentPalette[pi]||cfg.col;
  const [wr,wg,wb]=cfg.col;
  const pr=Math.round((r+wr)/2),pg=Math.round((g+wg)/2),pb=Math.round((b+wb)/2);
  const life=cfg.lMin+Math.random()*(cfg.lMax-cfg.lMin);
  let vx,vy;
  if(cfg.shape==='spark'){const a=Math.random()*Math.PI*2,s=(.5+Math.random())*cfg.spd;vx=Math.cos(a)*s;vy=Math.sin(a)*s}
  else{vx=(Math.random()-.5)*cfg.spd*.8;vy=-(0.3+Math.random()*.7)*cfg.spd}
  return{x:Math.random()*W,y:cfg.shape==='spark'?H*(.3+Math.random()*.5):H+10,vx,vy,sz:2+Math.random()*4,life,maxLife:life,r:pr,g:pg,b:pb,shape:cfg.shape,sinePh:Math.random()*Math.PI*2,sineAmp:(15+Math.random()*25)*(cfg.sine?1:0),flicker:Math.random()*Math.PI*2};
}

function drawParticle(p){
  const prog=p.life/p.maxLife,oFac=prog<.1?prog/.1:prog>.8?(1-prog)/.2:1,alpha=oFac*ambCfg.op;
  const{r,g,b}=p;
  ambCtx.save();ambCtx.globalAlpha=alpha;
  if(p.shape==='orb'){const gr=ambCtx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.sz*2.5);gr.addColorStop(0,`rgba(${r},${g},${b},1)`);gr.addColorStop(.4,`rgba(${r},${g},${b},.5)`);gr.addColorStop(1,`rgba(${r},${g},${b},0)`);ambCtx.beginPath();ambCtx.arc(p.x,p.y,p.sz*2.5,0,Math.PI*2);ambCtx.fillStyle=gr;ambCtx.fill()}
  else if(p.shape==='diamond'){const s=p.sz*1.4;ambCtx.beginPath();ambCtx.moveTo(p.x,p.y-s);ambCtx.lineTo(p.x+s*.6,p.y);ambCtx.lineTo(p.x,p.y+s);ambCtx.lineTo(p.x-s*.6,p.y);ambCtx.closePath();ambCtx.fillStyle=`rgba(${r},${g},${b},.85)`;ambCtx.fill()}
  else if(p.shape==='spark'){const spd=Math.sqrt(p.vx*p.vx+p.vy*p.vy)||1,tl=Math.min(spd*5,24),nx=p.vx/spd,ny=p.vy/spd;const gr=ambCtx.createLinearGradient(p.x-nx*tl,p.y-ny*tl,p.x,p.y);gr.addColorStop(0,`rgba(${r},${g},${b},0)`);gr.addColorStop(1,`rgba(${r},${g},${b},1)`);ambCtx.beginPath();ambCtx.moveTo(p.x-nx*tl,p.y-ny*tl);ambCtx.lineTo(p.x,p.y);ambCtx.strokeStyle=gr;ambCtx.lineWidth=1.5;ambCtx.lineCap='round';ambCtx.stroke();ambCtx.beginPath();ambCtx.arc(p.x,p.y,2,0,Math.PI*2);ambCtx.fillStyle='rgba(255,220,200,.9)';ambCtx.fill()}
  else if(p.shape==='ember'){const fl=.7+.3*Math.sin(p.flicker);const gr=ambCtx.createRadialGradient(p.x,p.y,0,p.x,p.y,p.sz*2.2);gr.addColorStop(0,`rgba(255,240,200,${fl})`);gr.addColorStop(.4,`rgba(${r},${g},${b},${fl*.7})`);gr.addColorStop(1,`rgba(${r},${g},${b},0)`);ambCtx.beginPath();ambCtx.arc(p.x,p.y,p.sz*2.2,0,Math.PI*2);ambCtx.fillStyle=gr;ambCtx.fill()}
  else if(p.shape==='mote'){const gr=ambCtx.createRadialGradient(p.x,p.y-p.sz*.3,0,p.x,p.y,p.sz*2);gr.addColorStop(0,`rgba(${r},${g},${b},.9)`);gr.addColorStop(1,`rgba(${r},${g},${b},0)`);ambCtx.beginPath();ambCtx.ellipse(p.x,p.y,p.sz*.7,p.sz*1.3,0,0,Math.PI*2);ambCtx.fillStyle=gr;ambCtx.fill()}
  ambCtx.restore();
}

function ambientLoop(){
  ambCtx.clearRect(0,0,ambCanvas.width,ambCanvas.height);
  const W=ambCanvas.width,H=ambCanvas.height,cfg=ambCfg;
  if(particles.length<cfg.n&&Math.random()<(cfg.shape==='spark'?.7:.25))particles.push(spawnParticle());
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    if(p.sineAmp>0){p.x+=Math.sin(p.sinePh)*.4;p.sinePh+=.02}
    p.x+=p.vx;p.y+=p.vy;p.life--;p.flicker+=.12+Math.random()*.08;
    if(p.shape==='ember')p.vy-=.003;
    if(p.life<=0||p.y<-30||p.x<-50||p.x>W+50||p.y>H+50)particles.splice(i,1);
    else drawParticle(p);
  }
  for(let i=ripples.length-1;i>=0;i--){
    const rip=ripples[i];rip.r+=rip.spd;rip.alpha-=.013;
    if(rip.alpha<=0||rip.r>rip.maxR){ripples.splice(i,1);continue}
    ambCtx.save();ambCtx.beginPath();ambCtx.arc(rip.x,rip.y,rip.r,0,Math.PI*2);ambCtx.strokeStyle=`rgba(${rip.r_rgb},${rip.g_rgb},${rip.b_rgb},${rip.alpha})`;ambCtx.lineWidth=1.5;ambCtx.stroke();ambCtx.restore();
  }
  moodColor.r+=(moodTarget.r-moodColor.r)*.018;
  moodColor.g+=(moodTarget.g-moodColor.g)*.018;
  moodColor.b+=(moodTarget.b-moodColor.b)*.018;
  requestAnimationFrame(ambientLoop);
}

// â”€â”€ INK BLOOM TRANSITION â”€â”€
const inkCanvas=document.getElementById('inkCanvas');
const inkCtx=inkCanvas.getContext('2d');
let inkRAF=null;
function resizeInk(){inkCanvas.width=innerWidth;inkCanvas.height=innerHeight}
resizeInk();

function startInkBloom(palette,onComplete){
  cancelAnimationFrame(inkRAF);
  inkCtx.clearRect(0,0,inkCanvas.width,inkCanvas.height);
  const W=inkCanvas.width,H=inkCanvas.height;
  const[r,g,b]=palette[0]||[20,20,20];
  inkCtx.globalCompositeOperation='source-over';
  inkCtx.fillStyle=`rgba(${Math.round(r*.3)},${Math.round(g*.3)},${Math.round(b*.3)},.97)`;
  inkCtx.fillRect(0,0,W,H);
  const blobs=Array.from({length:22},()=>({x:Math.random()*W,y:Math.random()*H,r:8+Math.random()*18,maxR:Math.sqrt(W*W+H*H)*(.28+Math.random()*.45),spd:7+Math.random()*9}));
  function tick(){
    inkCtx.globalCompositeOperation='destination-out';
    let done=true;
    blobs.forEach(bl=>{if(bl.r>=bl.maxR)return;done=false;bl.r+=bl.spd;const gr=inkCtx.createRadialGradient(bl.x,bl.y,0,bl.x,bl.y,bl.r);gr.addColorStop(0,'rgba(0,0,0,1)');gr.addColorStop(.65,'rgba(0,0,0,.9)');gr.addColorStop(1,'rgba(0,0,0,0)');inkCtx.beginPath();inkCtx.arc(bl.x,bl.y,bl.r,0,Math.PI*2);inkCtx.fillStyle=gr;inkCtx.fill()});
    if(done){inkCtx.globalCompositeOperation='destination-out';inkCtx.fillStyle='rgba(0,0,0,1)';inkCtx.fillRect(0,0,W,H);onComplete()}
    else inkRAF=requestAnimationFrame(tick);
  }
  inkRAF=requestAnimationFrame(tick);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUDIO ENGINE  (Chroma Tones + Procedural Nature Sounds)
//  Zero external files â€” everything synthesised with Web Audio API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx=null,masterGain=null,oscillators=[];
let soundEnabled=false;
const PENTA=[1,9/8,5/4,3/2,5/3];

// Nature sound state
let natureLayers={};          // currently running AudioNodes per layer
let natureGains={};           // GainNodes for each layer (for crossfade)
let currentNatureScene='';    // label of active scene
let natureMasterGain=null;    // separate gain tree for nature (keeps chroma independent)
let birdTimer=null,dropTimer=null,thunderTimer=null; // scheduled sound timers

// â”€â”€ INIT AUDIO CONTEXT â”€â”€
function initAudio(){
  if(audioCtx)return;
  audioCtx=new(window.AudioContext||window.webkitAudioContext)();

  // â”€ Chroma path: masterGain â†’ analyser â†’ reverb â†’ dest â”€
  masterGain=audioCtx.createGain();masterGain.gain.setValueAtTime(0,audioCtx.currentTime);
  analyser=audioCtx.createAnalyser();analyser.fftSize=256;freqData=new Uint8Array(analyser.frequencyBinCount);
  const irLen=audioCtx.sampleRate*2.2;
  const irBuf=audioCtx.createBuffer(2,irLen,audioCtx.sampleRate);
  for(let c=0;c<2;c++){const d=irBuf.getChannelData(c);for(let i=0;i<irLen;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/irLen,2.8)}
  const chromaRev=audioCtx.createConvolver();chromaRev.buffer=irBuf;
  masterGain.connect(analyser);analyser.connect(chromaRev);chromaRev.connect(audioCtx.destination);masterGain.connect(audioCtx.destination);

  // â”€ Nature path: natureMasterGain â†’ nature reverb â†’ dest â”€
  natureMasterGain=audioCtx.createGain();natureMasterGain.gain.setValueAtTime(0,audioCtx.currentTime);
  const natIrLen=audioCtx.sampleRate*3.5;
  const natIrBuf=audioCtx.createBuffer(2,natIrLen,audioCtx.sampleRate);
  for(let c=0;c<2;c++){const d=natIrBuf.getChannelData(c);for(let i=0;i<natIrLen;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/natIrLen,1.8)*0.4}
  const natRev=audioCtx.createConvolver();natRev.buffer=natIrBuf;
  natureMasterGain.connect(natRev);natRev.connect(audioCtx.destination);
  natureMasterGain.connect(audioCtx.destination); // dry signal
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LOW-LEVEL SOUND PRIMITIVES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// White noise buffer (3 seconds, reused)
let _noiseBuffer=null;
function getNoiseBuffer(){
  if(_noiseBuffer)return _noiseBuffer;
  const len=audioCtx.sampleRate*3;
  _noiseBuffer=audioCtx.createBuffer(2,len,audioCtx.sampleRate);
  for(let c=0;c<2;c++){const d=_noiseBuffer.getChannelData(c);for(let i=0;i<len;i++)d[i]=Math.random()*2-1}
  return _noiseBuffer;
}

// Create a looping filtered-noise layer
function makeNoiseLayer({lpFreq=2000,hpFreq=0,gain=0.1,type='lowpass',q=0.5}={}){
  const src=audioCtx.createBufferSource();
  src.buffer=getNoiseBuffer();src.loop=true;
  const g=audioCtx.createGain();g.gain.setValueAtTime(0,audioCtx.currentTime);
  const lp=audioCtx.createBiquadFilter();lp.type=type;lp.frequency.value=lpFreq;lp.Q.value=q;
  let chain=src;
  chain.connect(lp);chain=lp;
  if(hpFreq>0){const hp=audioCtx.createBiquadFilter();hp.type='highpass';hp.frequency.value=hpFreq;chain.connect(hp);chain=hp}
  chain.connect(g);g.connect(natureMasterGain);
  src.start();
  return{src,gainNode:g,targetGain:gain};
}

// LFO-modulate a gain node (simulates gusts/waves)
function attachLFO(gainNode,{rate=0.08,depth=0.4,base=0.3}={}){
  const lfo=audioCtx.createOscillator();
  const lfoGain=audioCtx.createGain();
  lfo.frequency.value=rate;lfo.type='sine';
  lfoGain.gain.value=depth;
  lfo.connect(lfoGain);lfoGain.connect(gainNode.gain);
  gainNode.gain.setValueAtTime(base,audioCtx.currentTime);
  lfo.start();
  return{lfo,lfoGain};
}

// Schedule one bird chirp (sine glide)
function scheduleBirdChirp(freq,dur,vol,delay){
  if(!audioCtx||!soundEnabled)return;
  const t=audioCtx.currentTime+delay;
  const osc=audioCtx.createOscillator(),g=audioCtx.createGain(),filt=audioCtx.createBiquadFilter();
  osc.type='sine';osc.frequency.setValueAtTime(freq,t);osc.frequency.exponentialRampToValueAtTime(freq*1.22,t+dur*.4);osc.frequency.exponentialRampToValueAtTime(freq*.88,t+dur);
  filt.type='bandpass';filt.frequency.value=freq;filt.Q.value=2;
  g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(vol,t+.02);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  osc.connect(filt);filt.connect(g);g.connect(natureMasterGain);
  osc.start(t);osc.stop(t+dur+.05);
}

// Schedule one water drip (sine decay + pitch drop)
function scheduleWaterDrop(delay){
  if(!audioCtx||!soundEnabled)return;
  const t=audioCtx.currentTime+delay;
  const freq=300+Math.random()*400;
  const osc=audioCtx.createOscillator(),g=audioCtx.createGain();
  osc.type='sine';osc.frequency.setValueAtTime(freq,t);osc.frequency.exponentialRampToValueAtTime(freq*.5,t+.15);
  g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.07,t+.008);g.gain.exponentialRampToValueAtTime(0.0001,t+.18);
  osc.connect(g);g.connect(natureMasterGain);osc.start(t);osc.stop(t+.22);
}

// Schedule one rain-drop click (noise burst)
function scheduleRainDrop(delay){
  if(!audioCtx||!soundEnabled)return;
  const t=audioCtx.currentTime+delay;
  const dur=0.04+Math.random()*0.08;
  const src=audioCtx.createBufferSource(),g=audioCtx.createGain(),filt=audioCtx.createBiquadFilter();
  src.buffer=getNoiseBuffer();
  filt.type='bandpass';filt.frequency.value=4000+Math.random()*3000;filt.Q.value=0.8;
  g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.06+Math.random()*.04,t+.004);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  src.connect(filt);filt.connect(g);g.connect(natureMasterGain);src.start(t);src.stop(t+dur+.01);
}

// Thunder rumble (low noise burst with slow envelope)
function scheduleThunder(delay){
  if(!audioCtx||!soundEnabled)return;
  const t=audioCtx.currentTime+delay;
  const src=audioCtx.createBufferSource(),g=audioCtx.createGain(),lp=audioCtx.createBiquadFilter();
  src.buffer=getNoiseBuffer();src.loop=true;
  lp.type='lowpass';lp.frequency.value=180;
  const dur=2.5+Math.random()*3;
  g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.12,t+.3);g.gain.setValueAtTime(.12,t+.5);g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
  src.connect(lp);lp.connect(g);g.connect(natureMasterGain);src.start(t);src.stop(t+dur+.1);
}

// Fire crackle (noise with fast random AM)
function makeFireLayer(){
  const src=audioCtx.createBufferSource(),g=audioCtx.createGain();
  const lp=audioCtx.createBiquadFilter(),hp=audioCtx.createBiquadFilter();
  src.buffer=getNoiseBuffer();src.loop=true;
  lp.type='lowpass';lp.frequency.value=1200;
  hp.type='highpass';hp.frequency.value=180;
  g.gain.setValueAtTime(0,audioCtx.currentTime);
  // AM modulator: irregular crackle via script
  const am=audioCtx.createOscillator(),amG=audioCtx.createGain();
  am.frequency.value=8+Math.random()*12;am.type='sawtooth';
  amG.gain.value=0.3;am.connect(amG);amG.connect(g.gain);
  src.connect(hp);hp.connect(lp);lp.connect(g);g.connect(natureMasterGain);
  src.start();am.start();
  return{src,gainNode:g,targetGain:0.09,am};
}

// Crickets (dense sine cloud at ~3.8kHz with tremolo)
function makeCricketsLayer(){
  const g=audioCtx.createGain();g.gain.setValueAtTime(0,audioCtx.currentTime);
  const oscs=[];
  for(let i=0;i<14;i++){
    const osc=audioCtx.createOscillator(),og=audioCtx.createGain();
    const freq=3700+i*55+Math.random()*30;
    osc.type='sine';osc.frequency.value=freq;
    // Tremolo per cricket
    const trem=audioCtx.createOscillator(),tg=audioCtx.createGain();
    trem.frequency.value=12+Math.random()*6;trem.type='sine';
    tg.gain.value=0.3+Math.random()*0.15;
    og.gain.setValueAtTime(0.018+Math.random()*0.012,audioCtx.currentTime);
    trem.connect(tg);tg.connect(og.gain);
    osc.connect(og);og.connect(g);
    osc.start();trem.start();
    oscs.push(osc,trem);
  }
  g.connect(natureMasterGain);
  return{gainNode:g,targetGain:0.12,oscs};
}

// Owl hoot (two-note descending sine glide)
function scheduleOwl(delay){
  if(!audioCtx||!soundEnabled)return;
  [0,0.55].forEach((offset,i)=>{
    const t=audioCtx.currentTime+delay+offset;
    const freq=i===0?320:290;
    const osc=audioCtx.createOscillator(),g=audioCtx.createGain(),filt=audioCtx.createBiquadFilter();
    osc.type='sine';osc.frequency.setValueAtTime(freq,t);osc.frequency.exponentialRampToValueAtTime(freq*.85,t+.45);
    filt.type='bandpass';filt.frequency.value=freq;filt.Q.value=3;
    g.gain.setValueAtTime(0,t);g.gain.linearRampToValueAtTime(.08,t+.04);g.gain.setValueAtTime(.08,t+.35);g.gain.exponentialRampToValueAtTime(0.0001,t+.48);
    osc.connect(filt);filt.connect(g);g.connect(natureMasterGain);osc.start(t);osc.stop(t+.55);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENE BUILDER â€” assembles and crossfades layer sets
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const NATURE_SCENES={
  // â”€â”€ DAWN FOREST (calm â€” morning 5-10h) â”€â”€
  dawn_forest:{
    label:'Dawn Forest',
    build(){
      return{
        wind:  makeNoiseLayer({lpFreq:380,hpFreq:60,gain:.055,type:'bandpass',q:.4}),
        birds_bg:makeNoiseLayer({lpFreq:6000,hpFreq:2500,gain:.018}),
        forest:makeNoiseLayer({lpFreq:280,hpFreq:40,gain:.04}),
      };
    },
    schedule(state){
      // Sparse dawn birds every 3-8s
      birdTimer&&clearTimeout(birdTimer);
      const chirp=()=>{
        if(!soundEnabled)return;
        const freqs=[2400,3100,2800,1900,3600,2200];
        const f=freqs[Math.floor(Math.random()*freqs.length)];
        scheduleBirdChirp(f,.18+Math.random()*.12,.06,0);
        if(Math.random()<.35)scheduleBirdChirp(f*1.5,.1,.04,.22);
        if(Math.random()<.2)scheduleWaterDrop(Math.random()*.8);
        birdTimer=setTimeout(chirp,3000+Math.random()*5000);
      };
      setTimeout(chirp,1000);
    },
    lfo:{wind:{rate:.07,depth:.28,base:.04}}
  },

  // â”€â”€ CITY PARK (focused â€” midday 10-14h) â”€â”€
  city_park:{
    label:'City Park',
    build(){
      return{
        wind:  makeNoiseLayer({lpFreq:500,hpFreq:80,gain:.04,type:'bandpass',q:.3}),
        leaves:makeNoiseLayer({lpFreq:7000,hpFreq:3000,gain:.022}),
        distant:makeNoiseLayer({lpFreq:200,hpFreq:30,gain:.025}),
      };
    },
    schedule(){
      birdTimer&&clearTimeout(birdTimer);
      const chirp=()=>{
        if(!soundEnabled)return;
        const f=[3200,2900,4100,3700][Math.floor(Math.random()*4)];
        scheduleBirdChirp(f,.12,.055,0);
        if(Math.random()<.5)scheduleBirdChirp(f*1.3,.09,.04,.15);
        birdTimer=setTimeout(chirp,4500+Math.random()*6000);
      };
      setTimeout(chirp,2000);
    },
    lfo:{wind:{rate:.12,depth:.2,base:.03}}
  },

  // â”€â”€ OPEN PRAIRIE (energized â€” afternoon 14-18h, vibrant palette) â”€â”€
  open_prairie:{
    label:'Open Prairie',
    build(){
      return{
        wind:  makeNoiseLayer({lpFreq:700,hpFreq:100,gain:.08,type:'bandpass',q:.35}),
        grass: makeNoiseLayer({lpFreq:4000,hpFreq:800,gain:.035}),
        gust:  makeNoiseLayer({lpFreq:250,hpFreq:50,gain:.055}),
      };
    },
    schedule(){
      birdTimer&&clearTimeout(birdTimer);
      const chirp=()=>{
        if(!soundEnabled)return;
        // Hawks / larks â€” higher energy
        const f=[4200,3800,5100,2600][Math.floor(Math.random()*4)];
        scheduleBirdChirp(f,.08+Math.random()*.1,.07,0);
        if(Math.random()<.6){scheduleBirdChirp(f*.75,.12,.06,.12)}
        if(Math.random()<.4){scheduleBirdChirp(f*1.5,.06,.05,.28)}
        birdTimer=setTimeout(chirp,1800+Math.random()*3000);
      };
      setTimeout(chirp,500);
    },
    lfo:{wind:{rate:.18,depth:.45,base:.055},gust:{rate:.04,depth:.35,base:.04}}
  },

  // â”€â”€ OCEAN SHORE (calm/focused â€” blue dominant palette) â”€â”€
  ocean:{
    label:'Ocean Shore',
    build(){
      return{
        waves: makeNoiseLayer({lpFreq:320,hpFreq:50,gain:.09}),
        surf:  makeNoiseLayer({lpFreq:1800,hpFreq:400,gain:.04}),
        wind:  makeNoiseLayer({lpFreq:420,hpFreq:80,gain:.03}),
      };
    },
    schedule(){
      birdTimer&&clearTimeout(birdTimer);
      const cry=()=>{
        if(!soundEnabled)return;
        // Seagull â€” descending glide
        scheduleBirdChirp(1400,.35+Math.random()*.2,.055,0);
        birdTimer=setTimeout(cry,6000+Math.random()*10000);
      };
      setTimeout(cry,3000+Math.random()*4000);
    },
    lfo:{waves:{rate:.055,depth:.55,base:.06},surf:{rate:.08,depth:.2,base:.03}}
  },

  // â”€â”€ EVENING FIRE (windDown â€” warm/orange palette) â”€â”€
  evening_fire:{
    label:'Evening Fire',
    build(){
      return{
        fire:  makeFireLayer(),
        wind:  makeNoiseLayer({lpFreq:300,hpFreq:50,gain:.03}),
        crickets:makeCricketsLayer(),
      };
    },
    schedule(){
      // Occasional cricket fade in handled by layer
    },
    lfo:{wind:{rate:.06,depth:.2,base:.022}}
  },

  // â”€â”€ RAIN FOREST (restore / green palette) â”€â”€
  rainforest:{
    label:'Rain Forest',
    build(){
      return{
        rain:  makeNoiseLayer({lpFreq:5500,hpFreq:1200,gain:.065}),
        forest:makeNoiseLayer({lpFreq:300,hpFreq:50,gain:.055}),
        thunder_bg:makeNoiseLayer({lpFreq:80,hpFreq:20,gain:.018}),
      };
    },
    schedule(){
      // Rain drops
      dropTimer&&clearTimeout(dropTimer);
      const drop=()=>{
        if(!soundEnabled)return;
        const n=4+Math.floor(Math.random()*5);
        for(let i=0;i<n;i++)scheduleRainDrop(i*(0.05+Math.random()*.12));
        dropTimer=setTimeout(drop,400+Math.random()*700);
      };
      drop();
      // Distant thunder occasionally
      thunderTimer&&clearTimeout(thunderTimer);
      const rumble=()=>{
        if(!soundEnabled)return;
        if(Math.random()<.45)scheduleThunder(0);
        thunderTimer=setTimeout(rumble,15000+Math.random()*25000);
      };
      setTimeout(rumble,8000+Math.random()*12000);
      // Deep forest birds
      birdTimer&&clearTimeout(birdTimer);
      const chirp=()=>{
        if(!soundEnabled)return;
        scheduleBirdChirp(1800+Math.random()*800,.25+Math.random()*.2,.045,0);
        birdTimer=setTimeout(chirp,5000+Math.random()*9000);
      };
      setTimeout(chirp,4000);
    },
    lfo:{rain:{rate:.15,depth:.18,base:.055}}
  },

  // â”€â”€ NIGHT FOREST (restore / dark/late night) â”€â”€
  night_forest:{
    label:'Night Forest',
    build(){
      return{
        crickets:makeCricketsLayer(),
        wind:    makeNoiseLayer({lpFreq:220,hpFreq:40,gain:.028}),
        deep:    makeNoiseLayer({lpFreq:90,hpFreq:20,gain:.03}),
      };
    },
    schedule(){
      birdTimer&&clearTimeout(birdTimer);
      const hoot=()=>{
        if(!soundEnabled)return;
        scheduleOwl(0);
        birdTimer=setTimeout(hoot,12000+Math.random()*18000);
      };
      setTimeout(hoot,5000+Math.random()*8000);
    },
    lfo:{wind:{rate:.05,depth:.2,base:.02}}
  },

  // â”€â”€ MOUNTAIN STREAM (green + blue palette) â”€â”€
  mountain_stream:{
    label:'Mountain Stream',
    build(){
      return{
        stream:makeNoiseLayer({lpFreq:3000,hpFreq:600,gain:.07}),
        wind:  makeNoiseLayer({lpFreq:400,hpFreq:70,gain:.04}),
        forest:makeNoiseLayer({lpFreq:250,hpFreq:40,gain:.035}),
      };
    },
    schedule(){
      birdTimer&&clearTimeout(birdTimer);
      const chirp=()=>{
        if(!soundEnabled)return;
        scheduleBirdChirp(2600+Math.random()*1200,.15+Math.random()*.1,.06,0);
        if(Math.random()<.4)scheduleWaterDrop(Math.random()*.4);
        dropTimer&&clearTimeout(dropTimer);
        const drip=()=>{if(!soundEnabled)return;scheduleWaterDrop(0);dropTimer=setTimeout(drip,1200+Math.random()*2000)};
        drip();
        birdTimer=setTimeout(chirp,3500+Math.random()*5000);
      };
      setTimeout(chirp,1500);
    },
    lfo:{stream:{rate:.11,depth:.3,base:.055},wind:{rate:.08,depth:.22,base:.03}}
  },
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENE SELECTION â€” maps wellbeing state + palette â†’ scene key
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function rgbToHueSat([r,g,b]){
  const R=r/255,G=g/255,B=b/255,mx=Math.max(R,G,B),mn=Math.min(R,G,B),d=mx-mn;
  if(d<.04)return{h:0,s:0,v:mx,lum:R*.299+G*.587+B*.114};
  let h=mx===R?((G-B)/d+6)%6:mx===G?(B-R)/d+2:(R-G)/d+4;
  return{h:h/6,s:mx>0?d/mx:0,v:mx,lum:R*.299+G*.587+B*.114};
}

function chooseScene(state,palette){
  const p=palette&&palette[0]?rgbToHueSat(palette[0]):{h:.55,s:.4,v:.5,lum:.5};
  const h=p.h,s=p.s,lum=p.lum;
  const hour=new Date().getHours();

  // Night hours always get night sounds
  if(hour>=22||hour<5) return'night_forest';

  // Palette-first overrides
  if(s>.4){
    if(h>.5&&h<.72&&lum<.55) return'ocean';          // blue/teal dominant
    if(h>.2&&h<.42&&s>.5)    return'mountain_stream'; // green dominant
    if((h<.08||h>.92)&&lum<.6) return'evening_fire'; // red/orange
  }

  // State-based fallbacks
  switch(state){
    case'calm':     return hour<9?'dawn_forest':'mountain_stream';
    case'focused':  return lum>.55?'city_park':'dawn_forest';
    case'energized':return'open_prairie';
    case'windDown': return lum<.45?'evening_fire':'night_forest';
    case'restore':  return s>.25&&h>.2&&h<.5?'rainforest':'night_forest';
    default:        return'dawn_forest';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCENE TRANSITION â€” crossfade old layers â†’ new layers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function stopAllNatureLayers(fadeTime=2.5){
  clearTimeout(birdTimer);clearTimeout(dropTimer);clearTimeout(thunderTimer);
  birdTimer=dropTimer=thunderTimer=null;
  Object.values(natureLayers).forEach(layer=>{
    if(!layer||!layer.gainNode)return;
    layer.gainNode.gain.setTargetAtTime(0,audioCtx.currentTime,fadeTime*.3);
    // Stop after fade
    setTimeout(()=>{
      try{layer.src&&layer.src.stop()}catch{}
      layer.oscs&&layer.oscs.forEach(o=>{try{o.stop()}catch{}});
      try{layer.am&&layer.am.stop()}catch{};
    },fadeTime*1000+200);
  });
  natureLayers={};
}

function transitionToScene(sceneKey,palette){
  if(!audioCtx||!soundEnabled)return;
  if(sceneKey===currentNatureScene){
    // Same scene â€” just re-schedule intermittent events
    const scene=NATURE_SCENES[sceneKey];
    if(scene)scene.schedule(session.currentState);
    return;
  }

  // Fade out old
  stopAllNatureLayers(2.0);
  currentNatureScene=sceneKey;

  const scene=NATURE_SCENES[sceneKey];
  if(!scene)return;

  // Update label
  const lbl=document.getElementById('natureSoundLabel');
  if(lbl){lbl.textContent=scene.label;lbl.style.opacity='1';setTimeout(()=>{lbl.style.opacity='0'},4000)}

  // Build new layers after brief pause
  setTimeout(()=>{
    if(!soundEnabled)return;
    natureLayers=scene.build();

    // Apply LFO modulation
    if(scene.lfo){
      Object.entries(scene.lfo).forEach(([key,cfg])=>{
        const layer=natureLayers[key];
        if(layer)attachLFO(layer.gainNode,cfg);
      });
    }

    // Fade in each layer
    Object.values(natureLayers).forEach(layer=>{
      if(!layer||!layer.gainNode)return;
      const tg=layer.targetGain||0.05;
      layer.gainNode.gain.setTargetAtTime(tg,audioCtx.currentTime,1.8);
    });

    // Schedule intermittent sounds (birds, drops, thunder)
    scene.schedule(session.currentState);
    // Fade in nature master
    natureMasterGain.gain.setTargetAtTime(.7,audioCtx.currentTime,2.0);
  },600);
}

// â”€â”€ PUBLIC: update nature sounds per photo â”€â”€
function updateNatureSounds(palette,state){
  if(!soundEnabled||!audioCtx)return;
  const sceneKey=chooseScene(state,palette);
  transitionToScene(sceneKey,palette);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHROMA TONE ENGINE (unchanged â€” runs in parallel)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function rgbToHueFrac([r,g,b]){const mx=Math.max(r,g,b)/255,mn=Math.min(r,g,b)/255,d=mx-mn;if(d<.05)return Math.random();let h=mx===r/255?((g-b)/255/d+6)%6:mx===g/255?(b-r)/255/d+2:(r-g)/255/d+4;return(h/6)}
function hueToFreq(h){const oct=Math.floor(h*3);return 110*Math.pow(2,oct)*PENTA[Math.floor((h*3%1)*5)]}

function playColorTone(palette){
  if(!soundEnabled||!audioCtx)return;
  masterGain.gain.setTargetAtTime(0,audioCtx.currentTime,.3);
  oscillators.forEach(o=>{try{o.stop(audioCtx.currentTime+.5)}catch{}});oscillators=[];
  setTimeout(()=>{
    if(!soundEnabled||!audioCtx)return;
    palette.slice(0,3).forEach(([r,g,b],i)=>{
      const h=rgbToHueFrac([r,g,b]),freq=hueToFreq(h);
      const osc=audioCtx.createOscillator(),gain=audioCtx.createGain(),filt=audioCtx.createBiquadFilter();
      osc.type=i===0?'sine':i===1?'triangle':'sine';
      osc.frequency.setValueAtTime(freq,audioCtx.currentTime);
      osc.detune.setValueAtTime((i===0?0:i===1?7:-5)+Math.random()*2,audioCtx.currentTime);
      filt.type='lowpass';filt.frequency.setValueAtTime(700+i*250,audioCtx.currentTime);
      gain.gain.setValueAtTime(.042/(i+1),audioCtx.currentTime);
      osc.connect(filt);filt.connect(gain);gain.connect(masterGain);osc.start();oscillators.push(osc);
    });
    masterGain.gain.setTargetAtTime(.18,audioCtx.currentTime,1.4);
  },400);
}

// â”€â”€ CONSTELLATION â”€â”€
const constellCanvas=document.getElementById('constellCanvas');
const constellCtx=constellCanvas.getContext('2d');
let constellAngle2=0;

function addConstellStar(palette,id){
  const[r,g,b,l]=palette[0];
  const h=rgbToHueFrac([r,g,b]);
  const mx=Math.max(r,g,b)/255,mn=Math.min(r,g,b)/255,sat=mx>0?(mx-mn)/mx:0;
  constellStars.push({r,g,b,h,sat,lum:l||.5,angle:h*Math.PI*2,radius:.18+sat*.74,id,added:Date.now(),size:1.5+(l||.5)*3.5});
  document.getElementById('cosmosCount').textContent=`${constellStars.length} photo${constellStars.length!==1?'s':''} charted`;
}

function drawConstellation(){
  const cvs=constellCanvas,ctx=constellCtx,sz=cvs.width;
  ctx.clearRect(0,0,sz,sz);constellAngle2+=.0018;
  const cx=sz/2,cy=sz/2,maxR=sz/2-10;
  const neb=ctx.createRadialGradient(cx,cy,0,cx,cy,maxR);neb.addColorStop(0,'rgba(255,255,255,.025)');neb.addColorStop(1,'rgba(0,0,0,0)');
  ctx.beginPath();ctx.arc(cx,cy,maxR,0,Math.PI*2);ctx.fillStyle=neb;ctx.fill();
  if(!constellStars.length){ctx.font='100 9px "Josefin Sans",sans-serif';ctx.fillStyle='rgba(255,255,255,.2)';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Your cosmos awaitsâ€¦',cx,cy);requestAnimationFrame(drawConstellation);return}
  if(constellStars.length>1){ctx.save();for(let i=1;i<constellStars.length;i++){const s0=constellStars[i-1],s1=constellStars[i];const a0=s0.angle+constellAngle2,a1=s1.angle+constellAngle2;const x0=cx+Math.cos(a0)*s0.radius*maxR,y0=cy+Math.sin(a0)*s0.radius*maxR;const x1=cx+Math.cos(a1)*s1.radius*maxR,y1=cy+Math.sin(a1)*s1.radius*maxR;const age=(Date.now()-s1.added)/1000;ctx.beginPath();ctx.moveTo(x0,y0);ctx.lineTo(x1,y1);ctx.strokeStyle=`rgba(255,255,255,${Math.max(.05,.18/(age*.04+1))})`;ctx.lineWidth=.7;ctx.stroke()}ctx.restore()}
  const now=Date.now();
  constellStars.forEach((s,i)=>{
    const a=s.angle+constellAngle2,sx=cx+Math.cos(a)*s.radius*maxR,sy=cy+Math.sin(a)*s.radius*maxR;
    const isCur=i===constellStars.length-1,pulse=isCur?1+.35*Math.sin((now-s.added)/320):1;
    if(isCur||s.lum>.5){const gl=ctx.createRadialGradient(sx,sy,0,sx,sy,s.size*4.5*pulse);gl.addColorStop(0,`rgba(${s.r},${s.g},${s.b},.45)`);gl.addColorStop(1,`rgba(${s.r},${s.g},${s.b},0)`);ctx.beginPath();ctx.arc(sx,sy,s.size*4.5*pulse,0,Math.PI*2);ctx.fillStyle=gl;ctx.fill()}
    ctx.beginPath();ctx.arc(sx,sy,s.size*pulse,0,Math.PI*2);ctx.fillStyle=`rgba(${s.r},${s.g},${s.b},${.6+s.lum*.4})`;ctx.fill();
    if(isCur){ctx.font='100 7px "Josefin Sans",sans-serif';ctx.fillStyle='rgba(255,255,255,.55)';ctx.textAlign='center';ctx.textBaseline='bottom';ctx.fillText(`#${i+1}`,sx,sy-s.size*2-3)}
  });
  requestAnimationFrame(drawConstellation);
}

// â”€â”€ COLOR DNA BAR â”€â”€
function updateColorBar(){
  const bar=document.getElementById('colorBar');bar.innerHTML='';
  const len=colorHistory.length;
  colorHistory.forEach(([r,g,b],i)=>{
    const lum=(.299*r+.587*g+.114*b)/255,h=Math.round(3+(1-lum)*9);
    const seg=document.createElement('span');seg.className='cb-seg';
    seg.style.background=`rgb(${r},${g},${b})`;
    seg.style.height=`${i===len-1?h+4:h}px`;
    seg.style.opacity=0.28+(i/len)*.72;
    if(i===len-1)seg.style.boxShadow=`0 0 6px rgba(${r},${g},${b},.7)`;
    bar.appendChild(seg);
  });
}

// â”€â”€ SUNDIAL CLOCK â”€â”€
const RH={6:'VI',9:'IX',12:'XII',15:'XV',18:'XVIII'};

function renderSundial(){
  if(!sundialCtx||!sundialCanvas)return;
  const ctx=sundialCtx,cvs=sundialCanvas,W=cvs.width,H=cvs.height;
  ctx.clearRect(0,0,W,H);
  const cx=W/2,cy=H*.78,R=W*.42,gnomH=R*.52;
  const now=new Date(),totalH=now.getHours()+now.getMinutes()/60+now.getSeconds()/3600;
  const prog=(Math.max(6,Math.min(18,totalH))-6)/12;
  const sunAngle=Math.PI+prog*Math.PI,shadowAngle=sunAngle-Math.PI;
  const mc=moodColor,mR=Math.round(mc.r),mG=Math.round(mc.g),mB=Math.round(mc.b);
  const mood=a=>`rgba(${mR},${mG},${mB},${a})`,moodS=`rgb(${mR},${mG},${mB})`;
  // Sky arc
  ctx.save();ctx.beginPath();ctx.moveTo(cx,cy);ctx.arc(cx,cy,R*.9,Math.PI,sunAngle,false);ctx.closePath();const sg=ctx.createRadialGradient(cx,cy,0,cx,cy,R);sg.addColorStop(0,mood(.14));sg.addColorStop(.7,mood(.07));sg.addColorStop(1,mood(0));ctx.fillStyle=sg;ctx.fill();ctx.restore();
  // Stone base
  ctx.save();const bW=R*1.1,bH=H*.22;const stg=ctx.createLinearGradient(cx,cy,cx,cy+bH);stg.addColorStop(0,'rgba(190,180,165,.55)');stg.addColorStop(1,'rgba(100,90,80,.2)');ctx.beginPath();ctx.moveTo(cx-bW*.48,cy);ctx.lineTo(cx+bW*.48,cy);ctx.lineTo(cx+bW*.36,cy+bH);ctx.lineTo(cx-bW*.36,cy+bH);ctx.closePath();ctx.fillStyle=stg;ctx.fill();ctx.beginPath();ctx.moveTo(cx-bW*.48,cy);ctx.lineTo(cx+bW*.48,cy);ctx.strokeStyle='rgba(255,255,255,.22)';ctx.lineWidth=1;ctx.stroke();ctx.restore();
  // Rings
  ctx.save();ctx.beginPath();ctx.arc(cx,cy,R,Math.PI,0,false);ctx.strokeStyle=mood(.22);ctx.lineWidth=7;ctx.stroke();ctx.beginPath();ctx.arc(cx,cy,R,Math.PI,0,false);ctx.strokeStyle='rgba(255,255,255,.58)';ctx.lineWidth=1.5;ctx.stroke();ctx.restore();
  // Hour ticks
  ctx.save();for(let h=6;h<=18;h++){const p2=(h-6)/12,a=Math.PI+p2*Math.PI,maj=h%3===0;ctx.beginPath();ctx.moveTo(cx+Math.cos(a)*(R-(maj?15:7)),cy+Math.sin(a)*(R-(maj?15:7)));ctx.lineTo(cx+Math.cos(a)*R,cy+Math.sin(a)*R);ctx.strokeStyle=maj?'rgba(255,255,255,.8)':'rgba(255,255,255,.3)';ctx.lineWidth=maj?2:1;ctx.stroke();if(RH[h]){const lr=R-30;ctx.font=`${h===12?'11px':'9px'} 'Cinzel',serif`;ctx.fillStyle=h===12?'rgba(255,255,255,.85)':'rgba(255,255,255,.45)';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(RH[h],cx+Math.cos(a)*lr,cy+Math.sin(a)*lr)}}ctx.restore();
  // Shadow
  const sLen=R*.73,sx=cx+Math.cos(shadowAngle)*sLen,sy=cy+Math.sin(shadowAngle)*sLen;
  ctx.save();ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(sx,sy);ctx.strokeStyle=mood(.2);ctx.lineWidth=9;ctx.lineCap='round';ctx.stroke();const shg=ctx.createLinearGradient(cx,cy,sx,sy);shg.addColorStop(0,mood(.95));shg.addColorStop(.55,mood(.65));shg.addColorStop(1,mood(.08));ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(sx,sy);ctx.strokeStyle=shg;ctx.lineWidth=2.8;ctx.lineCap='round';ctx.stroke();ctx.restore();
  // Gnomon
  ctx.save();const gnG=ctx.createLinearGradient(cx,cy,cx,cy-gnomH);gnG.addColorStop(0,'rgba(255,255,255,.9)');gnG.addColorStop(1,'rgba(255,255,255,.04)');ctx.beginPath();ctx.moveTo(cx-3.5,cy);ctx.lineTo(cx+3.5,cy);ctx.lineTo(cx,cy-gnomH);ctx.closePath();ctx.fillStyle=gnG;ctx.fill();ctx.restore();
  // Sun disc
  const sunX=cx+Math.cos(sunAngle)*R,sunY=cy+Math.sin(sunAngle)*R;
  if(sunY<=cy+4){ctx.save();const hl=ctx.createRadialGradient(sunX,sunY,0,sunX,sunY,20);hl.addColorStop(0,mood(.55));hl.addColorStop(.4,mood(.22));hl.addColorStop(1,mood(0));ctx.beginPath();ctx.arc(sunX,sunY,20,0,Math.PI*2);ctx.fillStyle=hl;ctx.fill();ctx.beginPath();ctx.arc(sunX,sunY,6,0,Math.PI*2);ctx.fillStyle=mood(.9);ctx.fill();ctx.beginPath();ctx.arc(sunX,sunY,3,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.96)';ctx.fill();ctx.globalAlpha=.2;for(let i=0;i<8;i++){const ra=i/8*Math.PI*2;ctx.beginPath();ctx.moveTo(sunX+Math.cos(ra)*9,sunY+Math.sin(ra)*9);ctx.lineTo(sunX+Math.cos(ra)*17,sunY+Math.sin(ra)*17);ctx.strokeStyle=moodS;ctx.lineWidth=1.5;ctx.lineCap='round';ctx.stroke()}ctx.restore()}
  // Center pivot
  ctx.save();ctx.beginPath();ctx.arc(cx,cy,5.5,0,Math.PI*2);ctx.fillStyle='rgba(255,255,255,.92)';ctx.fill();ctx.beginPath();ctx.arc(cx,cy,2.8,0,Math.PI*2);ctx.fillStyle=moodS;ctx.fill();ctx.restore();
  // Time text
  ctx.save();const h12=now.getHours()%12||12,mm=String(now.getMinutes()).padStart(2,'0'),ampm=now.getHours()>=12?'PM':'AM';
  ctx.shadowColor=mood(.45);ctx.shadowBlur=14;ctx.font=`300 ${Math.round(W*.095)}px 'Cormorant Garamond',serif`;ctx.fillStyle='rgba(255,255,255,.92)';ctx.textAlign='center';ctx.textBaseline='top';ctx.fillText(`${h12}:${mm} ${ampm}`,cx,cy+H*.058);
  ctx.shadowBlur=0;ctx.font=`100 ${Math.round(W*.042)}px 'Josefin Sans',sans-serif`;ctx.fillStyle='rgba(255,255,255,.3)';ctx.fillText(`${DAYS[now.getDay()].toUpperCase()} Â· ${MONTHS[now.getMonth()].slice(0,3).toUpperCase()} ${now.getDate()}`,cx,cy+H*.16);ctx.restore();
}

// â”€â”€ ANALOG CLOCK â”€â”€
function renderAnalog(){
  if(!analCtx||!analCanvas)return;
  const s=analCanvas.width,cx=s/2,cy=s/2,r=s/2-4;
  const d=new Date(),h=d.getHours()%12,m=d.getMinutes(),sec=d.getSeconds();
  const ctx=analCtx;ctx.clearRect(0,0,s,s);
  ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,.35)';ctx.fill();ctx.strokeStyle='rgba(255,255,255,.3)';ctx.lineWidth=1.5;ctx.stroke();
  for(let i=0;i<12;i++){const a=i/12*Math.PI*2-Math.PI/2,len=i%3===0?r*.12:r*.06;ctx.beginPath();ctx.moveTo(cx+Math.cos(a)*(r-len),cy+Math.sin(a)*(r-len));ctx.lineTo(cx+Math.cos(a)*r,cy+Math.sin(a)*r);ctx.strokeStyle=i%3===0?'rgba(255,255,255,.8)':'rgba(255,255,255,.35)';ctx.lineWidth=i%3===0?2:1;ctx.stroke()}
  const hand=(a,l,w,c)=>{ctx.beginPath();ctx.moveTo(cx,cy);ctx.lineTo(cx+Math.cos(a)*l,cy+Math.sin(a)*l);ctx.strokeStyle=c;ctx.lineWidth=w;ctx.lineCap='round';ctx.stroke()};
  hand(((h+m/60)/12)*Math.PI*2-Math.PI/2,r*.52,4,'rgba(255,255,255,.95)');
  hand(((m+sec/60)/60)*Math.PI*2-Math.PI/2,r*.72,2.5,'rgba(255,255,255,.9)');
  hand((sec/60)*Math.PI*2-Math.PI/2,r*.78,1.5,'#f85');
  ctx.beginPath();ctx.arc(cx,cy,4,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
}

// â”€â”€ HELPERS â”€â”€
const pad=n=>String(n).padStart(2,'0');
const DAYS=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
const MONTHS=['January','February','March','April','May','June','July','August','September','October','November','December'];
function timeStr(d,ap){let h=d.getHours(),m=d.getMinutes(),s=d.getSeconds();if(ap){const sf=h>=12?'PM':'AM';h=h%12||12;return`${pad(h)}:${pad(m)}:${pad(s)} ${sf}`}return`${pad(h)}:${pad(m)}:${pad(s)}`}
function hhmm(d){return`${pad(d.getHours()%12||12)}:${pad(d.getMinutes())}`}
function dateStr(d){return`${DAYS[d.getDay()]}, ${MONTHS[d.getMonth()]} ${d.getDate()}`}
function shortDate(d){return`${MONTHS[d.getMonth()].slice(0,3).toUpperCase()} ${d.getDate()} Â· ${d.getFullYear()}`}
function toRoman(n){const v=[1000,900,500,400,100,90,50,40,10,9,5,4,1],s=['M','CM','D','CD','C','XC','L','XL','X','IX','V','IV','I'];let o='';v.forEach((x,i)=>{while(n>=x){o+=s[i];n-=x}});return o}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a}
function buildImgPool(){
  const st=computeState();
  const statePhotos=[...UNSPLASH[st]];
  // Mix in a few from adjacent states for variety
  const allKeys=Object.keys(UNSPLASH).filter(k=>k!==st);
  allKeys.forEach(k=>{ const s=[...UNSPLASH[k]]; shuffle(s); statePhotos.push(...s.slice(0,3)); });
  imgPool=shuffle(statePhotos);
}
function unsplashUrl(id,w,h){return`https://images.unsplash.com/photo-${id}?auto=format&fit=crop&w=${w}&h=${h}&q=85`}
function unsplashThumb(id){return`https://images.unsplash.com/photo-${id}?auto=format&fit=crop&w=80&h=80&q=60`}function buildClockPool(){clockPool=shuffle(['minimal-digital','analog','sundial','editorial','handwritten','brutalist','roman','whisper','lcd','split'])}
function nextClockStyle(){if(!clockPool.length)buildClockPool();let s=clockPool.shift();if(s===activeClockStyle&&clockPool.length){clockPool.push(s);s=clockPool.shift()}activeClockStyle=s;return s}

// â”€â”€ LOAD BAR â”€â”€
const loadBar=document.getElementById('loadBar');
function barStart(){loadBar.style.width='55%';loadBar.style.opacity='1'}
function barDone(){loadBar.style.width='100%';setTimeout(()=>{loadBar.style.opacity='0';loadBar.style.width='0'},350)}

// â”€â”€ CLOCK BUILDERS â”€â”€
const CLOCK_BUILDERS={
  'minimal-digital':w=>{w.className='clock-minimal-digital';w.innerHTML=`<div class="time" id="ct"></div><div class="date" id="cd"></div>`;return()=>{const d=new Date();document.getElementById('ct').textContent=timeStr(d,true);document.getElementById('cd').textContent=dateStr(d).toUpperCase()}},
  'analog':w=>{const sz=Math.round(Math.min(innerWidth,innerHeight)*.22);w.className='clock-analog';w.innerHTML=`<canvas id="ac" width="${sz}" height="${sz}"></canvas>`;analCanvas=document.getElementById('ac');analCtx=analCanvas.getContext('2d');return renderAnalog},
  'sundial':w=>{const sz=Math.round(Math.min(innerWidth,innerHeight)*.44),sh=Math.round(sz*.64);w.className='clock-sundial';w.innerHTML=`<canvas id="sc" width="${sz}" height="${sh}"></canvas>`;sundialCanvas=document.getElementById('sc');sundialCtx=sundialCanvas.getContext('2d');return renderSundial},
  'editorial':w=>{w.className='clock-editorial';w.innerHTML=`<div class="time" id="ct"></div><div class="date" id="cd"></div>`;return()=>{const d=new Date();document.getElementById('ct').textContent=timeStr(d,false);document.getElementById('cd').textContent=shortDate(d)}},
  'handwritten':w=>{w.className='clock-handwritten';w.innerHTML=`<div class="time" id="ct"></div><div class="date" id="cd"></div>`;return()=>{const d=new Date();document.getElementById('ct').textContent=hhmm(d);document.getElementById('cd').textContent=dateStr(d)}},
  'brutalist':w=>{w.className='clock-brutalist';w.innerHTML=`<div class="time" id="ct"></div><div class="date" id="cd"></div>`;return()=>{const d=new Date();document.getElementById('ct').textContent=timeStr(d,false);document.getElementById('cd').textContent=shortDate(d)}},
  'roman':w=>{w.className='clock-roman';w.innerHTML=`<div class="time" id="ct"></div><div class="date" id="cd"></div>`;return()=>{const d=new Date();const h=d.getHours()%12||12,m=d.getMinutes();document.getElementById('ct').textContent=`${toRoman(h)} Â· ${toRoman(m||60)}`;document.getElementById('cd').textContent=`${DAYS[d.getDay()].toUpperCase()} Â· ${MONTHS[d.getMonth()].toUpperCase()} ${toRoman(d.getDate())}`}},
  'whisper':w=>{w.className='clock-whisper';w.innerHTML=`<div class="time" id="ct"></div><div class="date" id="cd"></div>`;return()=>{const d=new Date();document.getElementById('ct').textContent=timeStr(d,true);document.getElementById('cd').textContent=dateStr(d)}},
  'lcd':w=>{w.className='clock-lcd';w.innerHTML=`<div class="time" id="ct"></div><div class="date" id="cd"></div>`;return()=>{const d=new Date();document.getElementById('ct').textContent=timeStr(d,false);document.getElementById('cd').textContent=shortDate(d)}},
  'split':w=>{w.className='clock-split';w.innerHTML=`<div class="hours" id="ch"></div><div class="mins" id="cm"></div><div class="date" id="cd"></div>`;return()=>{const d=new Date();document.getElementById('ch').textContent=pad(d.getHours()%12||12);document.getElementById('cm').textContent=pad(d.getMinutes());document.getElementById('cd').textContent=shortDate(d)}},
};

function activateClock(style){
  clearInterval(clockTimer);analCanvas=null;analCtx=null;sundialCanvas=null;sundialCtx=null;
  const w=document.getElementById('clockWrap');w.className='hidden';w.removeAttribute('style');
  setTimeout(()=>{const tick=CLOCK_BUILDERS[style](w);tick();clockTimer=setInterval(tick,1000);w.classList.remove('hidden')},400);
}

// â”€â”€ IMAGE LOADING â”€â”€
async function fetchUnsplashInfo(id){
  // Use Unsplash oembed/noembed to get author without API key
  try{
    const r=await fetch(`https://noembed.com/embed?url=https://unsplash.com/photos/${id}`);
    if(r.ok){const d=await r.json();if(d.author_name)return{author:d.author_name,id}}
  }catch{}
  return{author:null,id};
}

async function showNext(){
  document.getElementById('nextBtn').disabled=true;
  barStart();recordInteraction();updateWbUI();
  document.getElementById('poetryDisplay').classList.remove('visible');
  document.getElementById('emotionRadar').classList.remove('visible');
  document.getElementById('poemLoader').style.display='flex';
  document.getElementById('panelPoemText').style.display='none';

  if(!imgPool.length)buildImgPool();
  const photoId=imgPool.shift();session.imgCount++;
  const W=innerWidth,H=innerHeight;
  const url=unsplashUrl(photoId,Math.round(W*window.devicePixelRatio||W),Math.round(H*window.devicePixelRatio||H));

  // Preload full image
  await new Promise(res=>{const img=new Image();img.src=url;img.onload=res;img.onerror=res});

  addRipples(currentPalette);

  startInkBloom(currentPalette,()=>{
    document.getElementById('bg').style.backgroundImage=`url('${url}')`;
    activateClock(nextClockStyle());
    barDone();
    document.getElementById('nextBtn').disabled=false;
    document.getElementById('imgCount').textContent=String(session.imgCount).padStart(3,'0');
    document.getElementById('photoAuthor').textContent='Photo via Unsplash';
    document.getElementById('photoId').textContent=``;
    // Async author fetch
    fetchUnsplashInfo(photoId).then(info=>{
      if(info.author)document.getElementById('photoAuthor').textContent=`Photo Â· ${info.author} Â· Unsplash`;
    });
  });

  // Color extraction from thumbnail
  extractColors(photoId).then(async palette=>{
    const st=computeState();
    if(!palette){const cfg=WB[st];palette=[[cfg.rgb[0],cfg.rgb[1],cfg.rgb[2],.5]]}
    currentPalette=palette;
    moodTarget={r:palette[0][0],g:palette[0][1],b:palette[0][2]};
    if(soundEnabled)playColorTone(palette);
    updateNatureSounds(palette,st);
    addConstellStar(palette,photoId);
    colorHistory.push(palette[0]);
    if(colorHistory.length>MAX_COLOR_HIST)colorHistory.shift();
    updateColorBar();
    drawRadar(palette);
    generatePoem(palette,{author:null},st).then(poem=>{
      if(poem)displayPoem(poem);
      else{document.getElementById('poemLoader').style.display='none';document.getElementById('panelPoemText').style.display='block';document.getElementById('panelPoemText').textContent='The colors speak in silenceâ€¦'}
    });
  });
}

// â”€â”€ PANEL / SOUND â”€â”€
function openPanel(){panelOpen=true;document.getElementById('wbPanel').classList.add('open');updateWbUI()}
function closePanel(){panelOpen=false;document.getElementById('wbPanel').classList.remove('open')}

document.getElementById('soundBtn').addEventListener('click',()=>{
  soundEnabled=!soundEnabled;
  const btn=document.getElementById('soundBtn');btn.textContent=soundEnabled?'â™¬':'â™ª';btn.classList.toggle('active',soundEnabled);
  if(soundEnabled){
    initAudio();
    if(audioCtx.state==='suspended')audioCtx.resume();
    playColorTone(currentPalette);
    updateNatureSounds(currentPalette,session.currentState);
  }else{
    masterGain&&masterGain.gain.setTargetAtTime(0,audioCtx.currentTime,.5);
    natureMasterGain&&natureMasterGain.gain.setTargetAtTime(0,audioCtx.currentTime,1.5);
    stopAllNatureLayers(1.5);
    currentNatureScene='';
    const lbl=document.getElementById('natureSoundLabel');if(lbl)lbl.style.opacity='0';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildMoodButtons();buildImgPool();buildClockPool();
skyLoop();           // â‘  Circadian sky
ambientLoop();       // particles + ripples
applyParallax();     // â‘¤ parallax (starts lerping toward 0)
specLoop();          // â‘¥ FFT spectrum halo loop
drawConstellation(); // constellation rotation loop
showNext();          // first photo
setInterval(updateWbUI,10000);

// â”€â”€ EVENTS â”€â”€
document.getElementById('wbPill').addEventListener('click',()=>panelOpen?closePanel():openPanel());
document.getElementById('wbPanelClose').addEventListener('click',closePanel);
document.getElementById('breakDismiss').addEventListener('click',()=>document.getElementById('breakBanner').classList.remove('show'));
document.getElementById('wbPanel').addEventListener('click',e=>e.stopPropagation());

let lastTap=0;
function handleDoubleTap(){if(!document.getElementById('nextBtn').disabled){buildImgPool();showNext()}}
document.addEventListener('touchend',e=>{const n=Date.now();if(n-lastTap<300){e.preventDefault();handleDoubleTap()}lastTap=n},{passive:false});
document.addEventListener('dblclick',()=>handleDoubleTap());
document.getElementById('nextBtn').addEventListener('click',e=>{e.stopPropagation();if(!document.getElementById('nextBtn').disabled){buildImgPool();showNext()}});

window.addEventListener('resize',()=>{
  resizeInk();resizeAmb();resizeSpec();initStars();
  if(activeClockStyle==='analog'&&analCanvas){const s=Math.round(Math.min(innerWidth,innerHeight)*.22);analCanvas.width=s;analCanvas.height=s}
  if(activeClockStyle==='sundial'&&sundialCanvas){const s=Math.round(Math.min(innerWidth,innerHeight)*.44);sundialCanvas.width=s;sundialCanvas.height=Math.round(s*.64)}
});
</script>
</body>
</html>
